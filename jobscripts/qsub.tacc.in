#!/bin/bash
#$ -V                    # Inherit submission environment
#$ -cwd                  # Start in submission directory
#$ -N suzerain           # Job name
#$ -o $JOB_NAME.o$JOB_ID # File containing job output
#$ -j y                  # Combine stderr and stdout
#$ -pe @corespernode@way @corespernode@          # Requests TpN tasks/node, (NoN x @corespernode@) cores total
#$ -q normal             # Queue name
#$ -l h_rt=00:30:00      # Run time (hh:mm:ss)
#$ -m bes                # Email on job begin, end, and suspension
#$ -M $USER              # Email to user that submitted the job
#$ -notify               # Notify job of impending doom
set -m                   # Employ job control
set -u                   # Abort on undefined shell variables

# Either obtain the soft run time or compute default from hard run time
RESOURCE_LIST=$(qstat -j $JOB_ID | grep resource_list)
H_RT=$(echo $RESOURCE_LIST | egrep -o 'h_rt=[0-9]+*' | egrep -o '[0-9]+')
S_RT=$(echo $RESOURCE_LIST | egrep -o 's_rt=[0-9]+*' | egrep -o '[0-9]+')
test -z "$S_RT" && S_RT=$(expr $H_RT - 60)
test "${S_RT:=0}" -lt 0 && S_RT=0

# Provide defaults for environment variables used to build CMD (see below).
# Rather than editing this job submission script, modify your environment!
: ${BINARY:=@bindir@/channel_explicit}
: ${INPUT:=@pkgdatadir@/fields/laminar_k08.h5}  # Use SCRATCH or WORK
: ${ADVANCE:=}
: ${STATUS:=--status_nt=25}
: ${DECOMP:=--Pa=$(expr $NSLOTS / $NHOSTS)}
: ${OPTIONS:=--Nx=192 --Ny=128 --Nz=128}
: ${TMPFILES:=--metadata=metadata.h5.$JOB_ID --uncommitted=uncommitted.h5.$JOB_ID}
: ${JOBDIR:=$SCRATCH/jobs/$JOB_NAME/$JOB_ID}

# Make job directory, canonicalize paths, and build command
mkdir -p "$JOBDIR"
BINARY=$(readlink -f "$BINARY")
INPUT=$(readlink -f "$INPUT")
JOBDIR=$(readlink -f "$JOBDIR")
cd -P "$JOBDIR"
# Copy any non-{SCRATCH,WORK} INPUT to JOBDIR to employ parallel filesystem
# Expensive for large fields but users should not be keeping those in $HOME
case "$INPUT" in                                                         #(
    "${SCRATCH}*") :
                   ;;                                                    #(
    "${WORK}*")    :
                   ;;                                                    #(
    *)             MSGS="${MSGS-}$(cp -v "$INPUT" "$JOBDIR/input.h5")\n"
                   INPUT=$(readlink -f "$JOBDIR/input.h5")
                   ;;
esac
CMD="\"$BINARY\" \"$INPUT\" $ADVANCE --advance_wt=$S_RT $STATUS $DECOMP $OPTIONS $TMPFILES"

# Compute threading based on job size and way-ness
export OMP_NUM_THREADS=$(expr @corespernode@ / \( $NSLOTS / $NHOSTS \) )

# Record execution details into working directory
exec 1> >(tee ./output) 2>&1
readlink -f "$BINARY" > ./binary
"$BINARY" --version > ./version
ldd "$BINARY" > ./dependencies
env > ./environment
test -f /proc/version && cp /proc/version ./kernel  && chmod +w ./kernel
test -f /proc/meminfo && cp /proc/meminfo ./meminfo && chmod +w ./meminfo
test -f /proc/cpuinfo && cp /proc/cpuinfo ./cpuinfo && chmod +w ./cpuinfo

# Display a job header
cat <<HEADER
=${JOB_NAME}===================================================================
CLUSTER:  $SGE_CLUSTER_NAME ${PE-} $NSLOTS
JOB_ID:   $JOB_ID
DATE:     $(date)
JOBDIR:   $JOBDIR
STDOUT:   $SGE_STDOUT_PATH
H_RT:     $H_RT

BINARY:   $BINARY
INPUT:    $INPUT
ADVANCE:  $ADVANCE
S_RT:     $S_RT
STATUS:   $STATUS
DECOMP:   $DECOMP
OPTIONS:  $OPTIONS
TMPFILES: $TMPFILES

${MSGS:-}${MSGS:+\n}
${CMD}
=${JOB_NAME}===================================================================

HEADER

# Exec the command so it may directly receive any incoming signals
cache_binary "$PWD" "$BINARY"
exec /usr/bin/time -v ibrun tacc_affinity $CMD
