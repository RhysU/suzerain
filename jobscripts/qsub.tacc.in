#!/bin/bash
#$ -V                    # Inherit submission environment
#$ -cwd                  # Start in submission directory
#$ -N suzerain           # Job name
#$ -o $JOB_NAME.o$JOB_ID # File containing job output
#$ -j y                  # Combine stderr and stdout
#$ -pe @corespernode@way @corespernode@          # Requests TpN tasks/node, (NoN x @corespernode@) cores total
#$ -q normal             # Queue name
#$ -l h_rt=00:30:00      # Run time (hh:mm:ss)
#$ -m bes                # Email on begin, end, and suspension
#$ -notify               # Notify job of impending doom
set -m                   # Employ job control
set -u                   # Abort on undefined shell variables

# Either obtain the soft run time or compute default from hard run time
RESOURCE_LIST=$(qstat -j $JOB_ID | grep resource_list)
H_RT=$(echo $RESOURCE_LIST | egrep -o 'h_rt=[0-9]+*' | egrep -o '[0-9]+')
S_RT=$(echo $RESOURCE_LIST | egrep -o 's_rt=[0-9]+*' | egrep -o '[0-9]+')
test -z "$S_RT" && S_RT=$(expr $H_RT - 60)
test "${S_RT:=0}" -lt 0 && S_RT=0

# Provide defaults for environment variables used to build CMD (see below).
# Rather than editing this job submission script, modify your environment!
: ${BINARY:=@bindir@/channel_explicit}
: ${INPUT:=@pkgdatadir@/fields/laminar_k08.h5}
: ${ADVANCE:=}
: ${STATUS:=--status_dt=0.01 --status_nt=25}
: ${DECOMP:=--Pa=$(expr $NSLOTS / $NHOSTS)}
: ${OPTIONS:=--Nx=192 --Ny=128 --Nz=128}
: ${TMPFILES:=--metadata=metadata.h5.$JOB_ID --uncommitted=uncommitted.h5.$JOB_ID}
: ${JOBDIR:=$SCRATCH/$JOB_ID}

# Canonicalize names, change to job directory, and build command
BINARY=$(readlink -f $BINARY)
INPUT=$(readlink -f $INPUT)
JOBDIR=$(readlink -f $JOBDIR)
mkdir -p "$JOBDIR"
cd -P "$JOBDIR"
CMD="\"$BINARY\" \"$INPUT\" $ADVANCE --advance_wt=$S_RT $STATUS $DECOMP $OPTIONS $TMPFILES"

# Compute threading based on job size and way-ness
export OMP_NUM_THREADS=$(expr @corespernode@ / \( $NSLOTS / $NHOSTS \) )

# Record execution details into working directory
exec 1> >(tee ./output) 2>&1
readlink -f "$BINARY" > ./binary
"$BINARY" --version > ./version
ldd "$BINARY" > ./dependencies
env > ./environment
test -f /proc/version && cp /proc/version ./kernel  && chmod +w ./kernel
test -f /proc/meminfo && cp /proc/meminfo ./meminfo && chmod +w ./meminfo
test -f /proc/cpuinfo && cp /proc/cpuinfo ./cpuinfo && chmod +w ./cpuinfo

# Display a job header
cat <<HEADER
=${JOB_NAME}===================================================================
CLUSTER:  $SGE_CLUSTER_NAME ${PE-} $NSLOTS
JOB_ID:   $JOB_ID
JOBDIR:   $JOBDIR
STDOUT:   $SGE_STDOUT_PATH
H_RT:     $H_RT

BINARY:   $BINARY
INPUT:    $INPUT
ADVANCE:  $ADVANCE
S_RT:     $S_RT
STATUS:   $STATUS
DECOMP:   $DECOMP
OPTIONS:  $OPTIONS
TMPFILES: $TMPFILES

$CMD
=${JOB_NAME}===================================================================

HEADER

# Exec the command so it may directly receive any incoming signals
cache_binary "$PWD" "$BINARY"
exec /usr/bin/time -v ibrun tacc_affinity $CMD
