\documentclass[letterpaper,11pt,nointlimits,reqno,draft]{amsart}

% Packages
\usepackage{accents}
\usepackage{algorithm}
\usepackage{algorithmic}
\usepackage{amsfonts}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{bm}
\usepackage{enumerate}
\usepackage{fancyhdr}
\usepackage{fullpage}
\usepackage{ifthen}
\usepackage{lastpage}
\usepackage{latexsym}
\usepackage{mathrsfs}
\usepackage{mathtools}
\usepackage{parskip}
\usepackage{pstricks}
\usepackage{rotating}
\usepackage{setspace}
\usepackage{txfonts}
\usepackage{units}
\usepackage{varioref}
\usepackage{wrapfig}
\usepackage{yhmath}

% Hyperref package must be last otherwise the contents are jumbled
% hypertexnames disabled to fix links pointing to incorrect locations
\usepackage[hypertexnames=false,final]{hyperref}

% Environment sidewaysfigure from rotating plays poorly with amsart class
% Fix per http://www.latex-community.org/forum/viewtopic.php?f=4&t=1742
\setlength\rotFPtop{0pt plus 1fil}

\mathtoolsset{showonlyrefs,showmanualtags}
%%% \allowdisplaybreaks[1] % Allow grouped equations to be split across pages

% Line Spacing
\singlespacing

% Increase table of contents depth
\setcounter{tocdepth}{4}

% Document-specific commands
\newcommand{\ii}{\ensuremath{\mathrm{i}}}
\newcommand{\trans}[1]{{#1}^{\ensuremath{\mathsf{T}}}}
\newcommand{\Mach}[1][]{\ensuremath{\mbox{Ma}_{#1}}}
\newcommand{\Reynolds}[1][]{\ensuremath{\mbox{Re}_{#1}}}
\newcommand{\Prandtl}[1][]{\ensuremath{\mbox{Pr}_{#1}}}
\newcommand{\reference}[1]{\ensuremath{\left\{#1\right\}_{0}}}
\newcommand{\lessreference}[1]
  {\ensuremath{\left({#1}-\reference{#1}\right)}}
\newcommand{\symmetricpart}[1]
  {\ensuremath{\operatorname{sym}\left(#1\right)}}
\DeclareMathOperator{\trace}{tr}

\begin{document}

\title{Suzerain model derivation,\\discretization, and numerical considerations}
\author{Rhys Ulerich}
\date{\today}
\thanks{Institute for Computational
    Engineering and Sciences, The University of Texas at Austin
    (rhys@ices.utexas.edu)}

\begin{abstract}
\end{abstract}

\maketitle
\renewcommand{\contentsname}{} % No idea why "Contents" appears in wrong location
\tableofcontents
\newpage

\section{Model derivation}
\label{sec:derivation}

Here we derive the mathematical model used in Suzerain.  Special attention is
paid to the origins of all conservation laws and constitutive relations
employed.  The model will nondimensionalized after derivation is complete.

\subsection{Conservation laws}

\subsubsection{Reynolds transport theorem}

Consider a time-varying control volume $\Omega$ with surface
$\partial\Omega$ and unit outward normal $\hat{n}$.  For any
scalar, vector, or tensor field quantity
$T$, Leibniz' theorem states
\begin{align}
  \label{eq:rtt}
  \frac{d}{dt}\int_{\Omega(t)}T(x,t)\,dV
  &=
  \int_{\Omega}\frac{\partial}{\partial{}t}T\,dV
  +
  \int_{\partial\Omega} \hat{n}\cdot{}w T\,dA
  =
  \int_{\Omega}\frac{\partial}{\partial{}t}T+\nabla\cdot{}wT\,dV
\end{align}
where $w$ is the velocity of $\partial\Omega$.  When $\Omega$ follows
a fixed set of fluid particles, $w$ becomes the fluid velocity $u$.

\subsubsection{Mass continuity}
Since mass $M=\int_{\Omega} \rho\,dV$
and mass conservation requires $\frac{d}{dt}M=0$,
\begin{align}
  0 = \frac{d}{dt}M
  = \frac{d}{dt}\int_{\Omega} \rho\,dV
  =
  \int_{\Omega}\frac{\partial}{\partial{}t}\rho+\nabla\cdot{}u\rho{}\,dV.
\end{align}
Because the result must hold for any control volume, we obtain
\begin{align}
  \label{eq:cons_mass}
  \frac{\partial}{\partial{}t}\rho+\nabla\cdot\rho{}u &= 0
  .
\end{align}

\subsubsection{Momentum equation}
Separating total force into surface forces and body forces
\begin{align}
  \sum{}F
  &=
     \int_{\partial\Omega} f_s \, dA
   + \int_{\Omega} f \, dV
  =
     \int_{\partial\Omega} \sigma \hat{n} \, dA
  +  \int_{\Omega} f \, dV
  =  \int_{\Omega} \nabla\cdot\sigma + f \, dV
\end{align}
where $\sigma$ is the Cauchy stress tensor.  Examining
momentum $I=\int_{\Omega} \rho{}u\,dV$ and its conservation
$\frac{d}{dt}I=\sum{}F$,
\begin{align}
    \int_{\Omega}\frac{\partial{}}{\partial{}t}\rho{}u
  + \nabla\cdot(u\otimes{}\rho{}u)\,dV
&= \int_{\Omega} \nabla\cdot\sigma + f \, dV
.
\end{align}
Because the control volume may be arbitrary,
\begin{align}
  \frac{\partial{}}{\partial{}t}\rho{}u + \nabla\cdot(u\otimes{}\rho{}u)
&= \nabla\cdot\sigma + f
.
\end{align}
Lastly, we separate the pressure $p$ and viscous contributions $\tau$ to
the Cauchy stress tensor so that $\sigma = -p I + \tau$,
\begin{align}
\label{eq:cons_momentum}
\frac{\partial{}}{\partial{}t}\rho{}u + \nabla\cdot(u\otimes{}\rho{}u)
&= -\nabla{}p + \nabla\cdot{}\tau + f
.
\end{align}

\subsubsection{Energy equation}
Lumping internal and kinetic energy into an intrinsic density $E$,
the energy $\mathscr{E}$ is
\begin{align}
  \mathscr{E} &= \int_{\Omega} \rho{}E \, dV
  .
\end{align}
Treating heat input $Q$ as both a surface phenomenon described by an outward
heat flux $q_{s}$ and as a volumetric phenomenon governed by a
body heating $q_{b}$,
\begin{align}
  Q
  &=
   \int_{\Omega}\rho{}q_{b}\,dV
  -\int_{\partial\Omega}\hat{n}\cdot{}q_{s}\,dA
  =
    \int_{\Omega}q_{b} - \nabla\cdot{}q_{s}\,dV
  .
\end{align}
Power input $P=F\cdot{}v$ accounts for surface stress work and body
force work to give
\begin{align}
  P
  &=
    \int_{\partial\Omega} \sigma{}\hat{n} \cdot{} u \, dA
  + \int_{\Omega} f \cdot{} u \, dV
  = \int_{\Omega} \nabla\cdot{}\sigma{}u + f \cdot{} u \, dV
  .
\end{align}
Demanding energy conservation $\frac{d}{dt}\mathscr{E}=Q+P$,
\begin{align}
  \int_{\Omega}\frac{\partial}{\partial{}t} \rho{}E
  +
  \nabla\cdot{}u\rho{}E
  \,dV
&=
    \int_{\Omega} q_{b} - \nabla\cdot{}q_{s}\,dV
  + \int_{\Omega} \nabla\cdot\sigma{}u + f \cdot{} u \, dV
  .
\end{align}
Again, since the control volume was arbitrary,
\begin{align}
  \frac{\partial}{\partial{}t} \rho{}E
  +
  \nabla\cdot{}\rho{}Eu
&=
  - \nabla\cdot{}q_{s}
  + \nabla\cdot\sigma{}u
  + f \cdot{} u
  + q_{b}
  .
\end{align}
After splitting $\sigma$'s pressure and viscous stress contributions we have
\begin{align}
  \label{eq:cons_energy}
  \frac{\partial}{\partial{}t} \rho{}E
  +
  \nabla\cdot{}\rho{}Eu
&=
  - \nabla\cdot{}q_{s}
  - \nabla\cdot{}pu
  + \nabla\cdot{}\tau{}u
  + f \cdot{} u
  + q_{b}
  .
\end{align}

\subsection{Constitutive relations and other assumptions}
\label{sec:constitutive}

\subsubsection{Perfect gas}

We assume our fluid is a thermally and calorically perfect gas governed by
\begin{align}
  \label{eq:perfectgaseos}
  p &= \rho{} R T
\end{align}
where $R$ is the gas constant. The constant volume $C_{v}$ specific heat,
constant pressure specific heat $C_{p}$, and acoustic velocity $a$
relationships follow:
\begin{align}
  \label{eq:perfectgasrelations}
  \gamma &= \frac{C_{p}}{C_{v}}
  &
  C_{v} &= \frac{R}{\gamma - 1}
  &
  C_{p} &= \frac{\gamma{}R}{\gamma-1}
  &
  R &= C_{p} - C_{v}
  &
  a^{2} = \gamma{}RT
\end{align}
We assume $\gamma$ and therefore $C_{v}$ and $C_{p}$ are constant.
The total (internal and kinetic) energy density is
\begin{align}
  \label{eq:perfectgastotalenergy}
  E &= C_{v} T + \frac{1}{2}u^{2}
     = \frac{RT}{\gamma-1} + \frac{1}{2}u^{2}
\end{align}
where the notation $u^2 = u\cdot{}u$ is employed.
The total enthalpy density $H$ and (internal) enthalpy density $h$ are
\begin{align}
  \label{eq:perfectgasenthalpy}
  H &= E + \frac{p}{\rho}
     = C_{p} T + \frac{1}{2}u^{2}
     = \frac{\gamma{}RT}{\gamma-1} + \frac{1}{2}u^{2}
  &
  h &= H - \frac{1}{2}u^{2}
     = C_{p} T
     = \frac{\gamma{}RT}{\gamma-1}
  .
\end{align}
See a gas dynamics reference, e.g.~\cite{LiepmannRoshko2002}, for more details.

\subsubsection{Newtonian fluid}
\label{sec:newtonianfluid}

If we seek a constitutive law for the viscous stress tensor $\tau$
using only velocity information, the principle of material frame
indifference implies that uniform translation (given by velocity $u$)
and solid-body rotation (given by the skew-symmetric rotation tensor
$\omega=\frac{1}{2}\left( \nabla{}u-\trans{\nabla{}u} \right)$)
may not influence $\tau$.  Considering contributions only up to the
gradient of velocity, extensional strain (dilatation) and shear strain
effects may depend on only the symmetric strain rate tensor
$\varepsilon=\frac{1}{2}\left( \nabla{}u+\trans{\nabla{}u}\right)$
and its principal invariants.

Assuming $\tau$ is isotropic and depends linearly upon only $\varepsilon$,
we can express it as
\begin{align}
\tau_{ij}
&= c_{ijmn} \varepsilon_{mn}
\notag \\
&= \left( A \delta_{ij} \delta_{mn}
        + B \delta_{im} \delta_{jn}
        + C \delta_{in} \delta_{jm}
    \right) \varepsilon_{mn}
&
&\text{for some }A, B, C\in\mathbb{R}
\notag \\
&= A \delta_{ij} \varepsilon_{mm} + B\varepsilon_{ij} + C\varepsilon_{ji}
\notag \\
&= A \delta_{ij} \varepsilon_{mm} + \left( B+C \right)\varepsilon_{ji}
\notag \\
&= 2 \mu \varepsilon_{ij} + \lambda\delta_{ij}\nabla\cdot{}u
\end{align}
where $\mu=\frac{1}{2}\left( B + C \right)$ is the dynamic coefficient of
viscosity (shear) and $\lambda=A$ is the second coefficient of viscosity
(dilatational).  Reverting to direct notation we have
\begin{align}
\tau
&= 2 \mu \varepsilon + \lambda \left( \nabla\cdot{}u \right) I
\notag \\
\label{eq:taunewt}
&=   \mu \left( \nabla{}u + \trans{\nabla{}u} \right)
  + \lambda \left( \nabla\cdot{}u \right) I
.
\end{align}

The bulk viscosity $\mu_{B}=\lambda + \frac{2}{3}\mu$ and the deviatoric
component of the strain rate tensor
\begin{align}
  S &= \varepsilon - \frac{1}{3} \trace\left(\varepsilon\right) I
     = \frac{1}{2}\left(\nabla{}u + \trans{\nabla{}u}\right)
     - \frac{1}{3}\left(\nabla\cdot{}u\right)I
\end{align}
may be used to write $\tau$ as
\begin{align}
\label{eq:tauSmub}
  \tau &= 2 \mu S + \mu_b  \left( \nabla\cdot{}u \right) I
.
\end{align}
The kinematic viscosity and bulk kinematic viscosity
\begin{align}
 \nu &= \frac{\mu}{\rho} & \nu_{B} &= \frac{\mu_{B}}{\rho}
\end{align}
are often used to simplify notation.

\subsubsection{Stokes' hypothesis}
\label{sec:stokeshypothesis}

We allow the bulk viscosity $\mu_{B}$ to be a fixed multiple of the dynamic
viscosity $\mu$.  One may write this relationship as either
\begin{align}
\label{eq:secondviscosityclaw}
\mu_{B} &= \alpha \mu
&
&\text{or}
&
\lambda &= \left( \alpha - \frac{2}{3} \right) \mu
\end{align}
where we have introduced a dimensionless proportionality constant $\alpha$.
Stokes' hypothesis that the bulk viscosity is negligible may be recovered by
selecting $\alpha = 0$.  Though Stokes' hypothesis is valid for most
circumstances~\cite{GadelHak1995}, we choose to separately track $\mu$ and
$\lambda$ terms in the model.

\subsubsection{Power law viscosity}

We assume that viscosity varies only with temperature according to
\begin{align}
\label{eq:powerlawviscosity}
\frac{\mu}{\mu_{0}}=\left(\frac{T}{T_{0}}\right)^{\beta}
\end{align}
where $\mu_{0}$ and $T_{0}$ are suitable reference values.  This
relationship models air well for temperatures up to several thousand
degrees Kelvin~\cite{NASA-TR-R-132}.

\subsubsection{Fourier's equation}

% TODO Radiative heat transfer negligible due to low temperature
% TODO Is heat transfer by molecular diffusion neglected due to time scale?
Neglecting the transport of energy by molecular diffusion and radiative
heat transfer, we seek a relation between the surface heat flux $q_{s}$
and the temperature $T$.  The principle of frame indifference implies
we may only use the temperature gradient so that
\begin{align}
  \label{eq:fouriertensorlaw}
  q_{s} &= \underline{\kappa} \cdot \nabla{} T
\end{align}
where $\underline{\kappa}$ is a thermal conductivity tensor.
Consistent with our assumption that $\tau$ is isotropic, we assume
$\underline{\kappa}$ is isotropic to obtain
\begin{align}
  \label{eq:fourierlaw}
  q_{s} &= - \kappa \nabla{} T
\end{align}
where $\kappa$ is the scalar thermal conductivity.  We introduce the
negative sign so that heat flows from hot to cold when $\kappa>0$.

\subsubsection{Constant Prandtl number}

We assume the Prandtl number $\Prandtl = \frac{\mu{}C_{p}}{\kappa}$ is constant.
Because $C_{p}$ is constant the ratio $\frac{\mu}{\kappa}$ must be
constant.  The viscosity and thermal conductivity must either grow at
identical rates or they must grow according to an inverse relationship.
The latter is not observed in practice for our class of fluids, and
so we assume
\begin{align}
  \frac{\mu}{\mu_{0}} = \frac{\kappa}{\kappa_{0}}
  .
  \label{eq:mukappa}
\end{align}

\subsection{Dimensional equations}

By combining the conservation laws with our constitutive relations
and assumptions, we arrive at the dimensional equations
\begin{subequations}\label{eq:dimensionalmodel}
\begin{align}
  \label{eq:dim_continuity}
  \frac{\partial}{\partial{}t}\rho
&=
  - \nabla\cdot\rho{}u
  \\
  \label{eq:dim_momentum}
  \frac{\partial{}}{\partial{}t}\rho{}u
&=
  - \nabla\cdot(u\otimes{}\rho{}u)
  -\nabla{} p
  + \nabla\cdot{} \tau
  + f
  \\
  \label{eq:dim_energy}
  \frac{\partial}{\partial{}t} \rho{}E
&=
  - \nabla\cdot{}\rho{}Eu
  + \nabla\cdot{} \frac{\kappa_{0}}{\mu_{0}} \mu \nabla{} T
  - \nabla\cdot{} p u
  + \nabla\cdot{}\tau{} u
  + f \cdot{} u
  + q_{b}
\intertext{
  where terms in the right hand side make use of
}
  \label{eq:dim_pressure}
  p &=   \left(\gamma-1\right)\left(\rho{}E
       - \frac{1}{2}\rho{}u^{2} \right)
  \\
  \label{eq:dim_temperature}
  T &= \frac{p}{\rho{}R}
  \\
  \label{eq:dim_viscosity}
  \mu &= \mu_{0} \left( \frac{T}{T_{0}} \right)^{\beta}
  \\
  \label{eq:dim_secondviscosity}
  \lambda &= \left(\alpha- \frac{2}{3}\right) \mu
  \\
  \label{eq:dim_viscousstress}
  \tau &=   \mu \left( \nabla{}u + \trans{\nabla{}u} \right)
          + \lambda \left( \nabla\cdot{}u \right) I
  .
\end{align}
\end{subequations}

\subsection{Nondimensionalization}
\label{sec:nondim}

\subsubsection{Introduction of nondimensional variables}
\label{sec:intronondim}

We rewrite the dimensional equations using nondimensional variables
combined with arbitrary reference quantities.  For each dimensional
quantity in the dimensional model we introduce a nondimensional variable
or operator denoted by a superscript star, e.g. $\nabla^{*}$.

We introduce $t^{*}=\frac{t}{t_{0}}$ and $x^{*}=\frac{x}{l_{0}}$ for some
reference $t_{0}$ and $l_{0}$.  This induces the following relationships:
\begin{align}
  \frac{\partial{}}{\partial{}t}
  &=
  \frac{\partial{}}{\partial{}t^{*}}
  \frac{\partial{}t^{*}}{\partial{}t}
  =
  \frac{1}{t_{0}}\frac{\partial}{\partial{}t^{*}}
  &
  \frac{\partial{}}{\partial{}x}
  &=
  \frac{\partial{}}{\partial{}x^{*}}
  \frac{\partial{}x^{*}}{\partial{}x}
  =
  \frac{1}{l_{0}}\frac{\partial}{\partial{}x^{*}}
  &
  \nabla
  &=
  \hat{e}_{i} \frac{\partial{}}{\partial{}x_{i}}
  =
  \hat{e}_{i} \frac{1}{l_{0}} \frac{\partial}{\partial{}x^{*}_{i}}
  =
  \frac{1}{l_{0}} \nabla^{*}
  \label{eq:nondim_derivops}
\end{align}

We introduce more nondimensional quantities (e.g. $\rho^{*} =
\frac{\rho}{\rho_{0}}$) and use them to reexpress the model
\begin{subequations}\label{eq:dimwithref_model}
\begin{align}
  \label{eq:dimwithref_continuity}
  \frac{\rho_{0}}{t_{0}} \frac{\partial}{\partial{}t^{*}}\rho^{*}
&=
  - \frac{\rho_{0}u_{0}}{l_{0}} \nabla^{*}\cdot\rho^{*}u^{*}
  \\
  \label{eq:dimwithref_momentum}
  \frac{\rho_{0}u_{0}}{t_{0}} \frac{\partial{}}{\partial{}t^{*}}\rho^{*}u^{*}
&=
  - \frac{\rho_{0}u_{0}^{2}}{l_{0}}
    \nabla^{*}\cdot(u^{*}\otimes{}\rho^{*}u^{*})
  - \frac{p_{0}}{l_{0}} \nabla^{*} p^{*}
  + \frac{\tau_{0}}{l_{0}} \nabla^{*}\cdot{} \tau^{*}
  + f_{0} f^{*}
  \\
  \label{eq:dimwithref_energy}
  \frac{\rho_{0}E_{0}}{t_{0}}
  \frac{\partial}{\partial{}t^{*}} \rho^{*}E^{*}
&=
  - \frac{\rho_{0}E_{0}u_{0}}{l_{0}} \nabla^{*} \cdot{}\rho^{*}E^{*}u^{*}
  + \frac{\kappa_{0}T_{0}}{l_{0}^{2}}
    \nabla^{*}\cdot{} \mu^{*} \nabla^{*} T^{*}
  - \frac{p_{0}u_{0}}{l_{0}} \nabla^{*}\cdot{} p^{*} u^{*}
\notag\\
&\quad{}+ \frac{\tau_{0}u_{0}}{l_{0}} \nabla^{*}\cdot{}\tau^{*} u^{*}
  + f_{0}u_{0} f^{*} \cdot{} u^{*}
  + q_{0} q_{b}^{*}
\intertext{
  where terms in the right hand side are computed using
}
  \label{eq:dimwithref_pressure}
  p^{*} &= \frac{\gamma-1}{p_{0}} \left(
        \rho_{0}E_{0}\rho^{*}E^{*}
      - \rho_{0}u_{0}^{2}\,\rho^{*}\frac{u^{*}\cdot{}u^{*}}{2}
  \right)
  \\
  \label{eq:dimwithref_temperature}
  T^{*} &= \frac{p_{0}p^{*}}{\rho_{0}RT_{0}\,\rho^{*}}
  \\
  \label{eq:dimwithref_viscosity}
  \mu^{*} &= \left( T^{*} \right)^{\beta}
  \\
  \label{eq:dimwithref_secondviscosity}
  \lambda^{*} &= \left(\alpha - \frac{2}{3}\right) \mu^{*}
  \\
  \label{eq:dimwithref_viscousstress}
  \tau^{*} &= \frac{\mu_{0}u_{0}}{l_{0} \tau_{0}} \left[
      \mu^{*} \left( \nabla^{*}u^{*} + \trans{\nabla^{*}u^{*}} \right)
      + \lambda^{*} \left( \nabla^{*}\cdot{}u^{*} \right) I
    \right]
  .
\end{align}
\end{subequations}
Notice that $\lambda$ has been nondimensionalized using $\mu_{0}$.  At this
stage, we have many more reference quantities than the underlying quantity
dimensions warrant.

\subsubsection{Reference quantity selections}
\label{sec:nondimrefq}

We choose a reference density $\rho_{0}$, length $l_{0}$, velocity $u_{0}$, and
temperature $T_{0}$.  These selections fix all other dimensional reference
quantities:
\begin{align}
  a_{0} &= \sqrt{\gamma{}RT_{0}}
  &
  E_{0}, H_{0}, h_{0} &= a_{0}^{2}
  &
  p_{0} &= \rho_{0} a_{0}^{2}
  &
  t_{0} &= \frac{l_{0}}{u_{0}}
  &
  \tau_{0} &= \frac{\mu_{0}u_{0}}{l_{0}}
  &
  f_{0} &= \frac{\rho_{0}u_{0}}{t_{0}}
  &
  q_{0} &= \frac{\rho_{0}a_{0}^{2}}{t_{0}}
\end{align}
Because we assume viscosity varies only with temperature, $\mu_{0}=\mu\!\left(
T_{0} \right)$ is fixed by $T_{0}$.  Because we assume a constant Prandtl
number, $\kappa_{0}=\kappa\!\left( \mu\!\left( T_{0} \right) \right)$ is also
fixed by $T_{0}$.  Choosing this form for $p_{0}$ in lieu of employing
equation~\eqref{eq:perfectgaseos} is customary and removes many instances of
$\gamma$ from the resulting equations.  Note that these reference choices imply
\begin{align}
a^{*}&=\sqrt{T^{*}}
&
&\text{and}
&
h^{*}&=\frac{T^{*}}{\gamma-1}
.
\end{align}

\subsubsection{Nondimensional equations}
\label{nondim_equations}

We employ the reference quantity relationships after multiplying the
continuity, momentum, and energy equations by $\frac{t_{0}}{\rho_{0}}$,
$\frac{t_{0}}{\rho_{0}u_{0}}$, and $\frac{t_{0}}{\rho_{0}E_{0}}$
respectively.  Henceforth we suppress the superscript star notation because all
terms are dimensionless.  We arrive at the following nondimensional equations
\begin{subequations}
\begin{align}
  \label{eq:nondim_continuity}
  \frac{\partial}{\partial{}t}\rho{}
&=
  - \nabla\cdot\rho{}u
  \\
  \label{eq:nondim_momentum}
  \frac{\partial}{\partial{}t}\rho{}u
&=
  - \nabla\cdot(u\otimes\rho{}u)
  - \frac{1}{\Mach^{2}} \nabla{} p
  + \frac{1}{\Reynolds} \nabla\cdot\tau
  + f
  \\
  \label{eq:nondim_energy}
  \frac{\partial}{\partial{}t} \rho{}E
&=
  - \nabla\cdot\rho{}Eu
  + \frac{1}{\Reynolds\,\Prandtl\,\left( \gamma - 1 \right)}
    \nabla\cdot\mu\nabla{} T
  - \nabla\cdot{} p u
  + \frac{\Mach^{2}}{\Reynolds} \nabla\cdot\tau{} u
  + \Mach^{2} f \cdot{} u
  + q_{b}
\intertext{
along with the relationships
}
  \label{eq:nondim_pressure}
  p &= \left(\gamma-1\right) \left(
    \rho{}E - \frac{\Mach^{2}}{2}\rho{}u^{2}
  \right)
  \\
  \label{eq:nondim_temperature}
  T &= \gamma{} \frac{p}{\rho}
  \\
  \label{eq:nondim_viscosity}
  \mu &= T^{\beta}
  \\
  \label{eq:nondim_secondviscosity}
  \lambda &= \left(\alpha-\frac{2}{3}\right)\mu
  \\
  \label{eq:nondim_viscousstress}
  \tau &=  \mu\left(\nabla{}u+\trans{\nabla{}u}\right)
         + \lambda\left(\nabla\cdot{}u\right) I
\end{align}
\end{subequations}
where the nondimensional quantities
\begin{align}
  \Reynolds &= \frac{\rho_{0}u_{0}l_{0}}{\mu_{0}}
  &
  \Mach &= \frac{u_{0}}{a_{0}}
  &
  \Prandtl &= \frac{\mu_{0}C_{p}}{\kappa_{0}}
\end{align}
are the Reynolds, Mach, and Prandtl numbers, respectively.

Introducing a velocity reference $u_{0}$ separate from the sound speed $a_{0}$
was not necessary from a dimensional standpoint.  Doing so is the origin of the
$\Mach$ factors appearing above.  These add some minor complexity to the
equations but greatly simplify investigating the physics in the various
$\Mach\to{}0$ limits.

\section{Discretization}
\label{sec:discretization}

Here we discuss the space and time discretization techniques employed to solve
the continuous model equations.  In this section $u$ denotes an arbitrary state
vector and not fluid velocity.

\subsection{Spatial discretization}
\label{sec:spatialdiscretization}

We start with the continuous system
\begin{align}
  \frac{\partial}{\partial{}t} u &= \mathscr{L}u + \mathscr{N}\!\left(u\right)
\end{align}
on the spatial domain $\left[-\frac{L_x}{2},\frac{L_x}{2}\right] \times{}
[0,L_y] \times{} \left[-\frac{L_z}{2},\frac{L_z}{2}\right]$.  The operators
$\mathscr{L}$ and $\mathscr{N}$ are linear and nonlinear, respectively.  For
brevity, the section suppresses any time dependence in the operators.  To begin
spatially discretizing the system, we introduce its finite dimensional analog
\begin{align}
  \frac{\partial}{\partial{}t} u^h
  &=
  \mathscr{L}u^h + \mathscr{N}\!\left(u^h\right) + R^h
  \label{eq:discrete_system_with_residual}
\end{align}
where continuous $u = u\!\left(x,y,z,t\right)$ has been replaced by discrete
$u^h = u^h\!\left(x,y,z,t\right)$ with $N_x\times{}N_y\times{}N_z$ degrees of
freedom.  Here, $R^h$ is the discretization error that arises because the
discrete solution cannot satisfy the continuous equations everywhere in space.
We select Fourier expansions for the periodic $x$ and $z$ directions and a
B-spline expansion for the non-periodic $y$ direction.  That is,
\begin{align}
u^h(x,y,z,t)
&=
  \sum_{l=0}^{N_y - 1}
  \sum_{m=-\frac{N_x}{2}}^{\frac{N_x}{2}-1}
  \sum_{n=-\frac{N_z}{2}}^{\frac{N_z}{2}-1}
  \hat{u}_{l m n}(t)
  B_l\!\left(y\right)
  e^{\ii\frac{2\pi{}m}{L_x}x}
  e^{\ii\frac{2\pi{}n}{L_z}z}
  \\
&=
  \sum_{l}\sum_{m}\sum_{n}
  \hat{u}_{l m n}(t)B_l\!\left(y\right)e^{\ii k_m x}e^{\ii k_n z}
  \label{eq:u_h_expansion}
\end{align}
where $k_m = 2\pi{}m/L_x$, $k_n = 2\pi{}n/L_z$, and $B_l\!\left(y\right)$ are a
B-spline basis for some order and knot selection.

Now, within the method of weighted residuals framework, we choose a mixed
Galerkin/collocation approach (often called a ``pseudospectral'' technique)
employing the $L_{2}$ inner product and test ``functions'' like
$\delta(y-y_{l'}) e^{\ii k_{m'} x}e^{\ii k_{n'} z}$ where $l'$, $m'$, and $n'$
range over the same values as $l$, $m$, and $n$, respectively.  The fixed
collocation points $y_{l'}$ depend on the B-spline basis details.  We catalog
three relevant results
\begin{align}
   \int_0^{L_y} \varphi(y) \, \delta(y-y_{l'}) \,d\!y
&= \varphi(y_{l'}),
&
   \int_{-\frac{L_x}{2}}^{\frac{L_x}{2}} e^{\ii k_m x} e^{-\ii k_{m'} x} \,d\!x
&= L_x \delta_{m m'}, \text{ and}
&
   \int_{-\frac{L_z}{2}}^{\frac{L_z}{2}} e^{\ii k_n z} e^{-\ii k_{n'} z} \,d\!z
&= L_z \delta_{n n'}
\end{align}
where the inner product's conjugate operation is accounted for by introducing a
negative sign into the latter two exponentials.  We force the weighted residual
to be zero in the sense that
\begin{align}
  \int_0^{L_y}
  \int_{-\frac{L_x}{2}}^{\frac{L_x}{2}}
  \int_{-\frac{L_z}{2}}^{\frac{L_z}{2}}
  R^h\!\left(x,y,z\right) \delta(y-y_{l'}) e^{-\ii k_{m'} x}e^{-\ii k_{n'} z}
  \,d\!z \,d\!x \,d\!y
  &=
  0
  \label{eq:R_h_weighted_residual_zero}
\end{align}
holds for all $l'$, $m'$, and $n'$.  Inserting \eqref{eq:u_h_expansion} into
\eqref{eq:discrete_system_with_residual}, testing with our test functions,
applying \eqref{eq:R_h_weighted_residual_zero}, and simplifying each remaining
term separately we obtain the following:
\begin{align}
 \int_0^{L_y}
 \int_{-\frac{L_x}{2}}^{\frac{L_x}{2}}
 \int_{-\frac{L_z}{2}}^{\frac{L_z}{2}}
 \,
 &\frac{\partial}{\partial{}t}
  \left(
    \sum_{l}\sum_{m}\sum_{n}
    \hat{u}_{l m n}(t)B_l\!\left(y\right)e^{\ii k_m x}e^{\ii k_n z}
  \right)
  \left(
    \delta(y-y_{l'}) e^{-\ii k_{m'} x}e^{-\ii k_{n'} z}
  \right)
  \, dz \, dx \, dy
\\
  &=
  L_x L_z \sum_{l} B_l\!\left(y_{l'}\right)
  \frac{\partial}{\partial{}t} \hat{u}_{l m n}(t)
\\
 \int_0^{L_y}
 \int_{-\frac{L_x}{2}}^{\frac{L_x}{2}}
 \int_{-\frac{L_z}{2}}^{\frac{L_z}{2}}
 \,
 &\mathscr{L}
  \left(
    \sum_{l}\sum_{m}\sum_{n}
    \hat{u}_{l m n}(t)B_l\!\left(y\right)e^{\ii k_m x}e^{\ii k_n z}
  \right)
  \left(
    \delta(y-y_{l'}) e^{-\ii k_{m'} x}e^{-\ii k_{n'} z}
  \right)
  \, dz \, dx \, dy
\\
  &=
  L_x L_z
  \mathscr{L}\left(
     \sum_{l}
      B_l\!\left(y_{l'}\right)
     \hat{u}_{l m n}(t)
   \right)
\intertext{} % Allow soft break
  \int_0^{L_y}
  \int_{-\frac{L_x}{2}}^{\frac{L_x}{2}}
  \int_{-\frac{L_z}{2}}^{\frac{L_z}{2}}
  &\mathscr{N}\left(
     \sum_{l}\sum_{m}\sum_{n}
     \hat{u}_{l m n}(t)B_l\!\left(y\right)e^{\ii k_m x}e^{\ii k_n z}
   \right)
   \left(
     \delta(y-y_{l'}) e^{-\ii k_{m'} x}e^{-\ii k_{n'} z}
   \right)
   \, dz \, dx \, dy
\\
  &=
  \int_{-\frac{L_x}{2}}^{\frac{L_x}{2}}
  \int_{-\frac{L_z}{2}}^{\frac{L_z}{2}}
  \mathscr{N}\left(
    \sum_{m}\sum_{n}
    \left(
      \sum_{l} B_l\!\left(y_{l'}\right)
      \hat{u}_{l m n}(t)
    \right)
    e^{\ii k_m x}e^{\ii k_n z}
  \right)
  \left(
    e^{-\ii k_{m'} x}e^{-\ii k_{n'} z}
  \right)
  \, dz \, dx
\intertext{
  Reequating the terms we have
}
  L_x L_z
  \sum_{l} B_l\!\left(y_{l'}\right)
  \frac{\partial}{\partial{}t} \hat{u}_{l m n}(t)
  &=
  L_x L_z
  \mathscr{L}\left(
    \sum_{l}
     B_l\!\left(y_{l'}\right)
    \hat{u}_{l m n}(t)
  \right)
\\
  &{}+
  \int_{-\frac{L_x}{2}}^{\frac{L_x}{2}}
  \int_{-\frac{L_z}{2}}^{\frac{L_z}{2}}
  \mathscr{N}\left(
    \sum_{m}\sum_{n}
    \left(
      \sum_{l} B_l\!\left(y_{l'}\right)
      \hat{u}_{l m n}(t)
    \right)
    e^{\ii k_m x}e^{\ii k_n z}
  \right)
  \left(
    e^{-\ii k_{m'} x}e^{-\ii k_{n'} z}
  \right)
  \, dz \, dx
  .
 \end{align}

Finally, approximating the two integrals by discrete sums and dividing
by $L_x$ and $L_z$ leaves us with
\begin{align}
  \sum_{l} B_l\!\left(y_{l'}\right)
  \frac{\partial}{\partial{}t} \hat{u}_{l m n}(t)
  &\approx
  \mathscr{L}\left(
    \sum_{l}
     B_l\!\left(y_{l'}\right)
    \hat{u}_{l m n}(t)
  \right)
\\
  &{}+
  \frac{1}{N_x N_z}
  \sum_{m'} \sum_{n'}
  \mathscr{N}\left(
    \sum_{m}
    \sum_{n}
    \left(
      \sum_{l} B_l\!\left(y_{l'}\right)
      \hat{u}_{l m n}(t)
    \right)
    e^{\ii k_m x_{m'}}e^{\ii k_n z_{n'}}
  \right)
  \!\!
  \left(
    e^{-\ii k_{m'} x_m}e^{-\ii k_{n'} z_n}
  \right)
  \label{eq:spatial_discretization}
\end{align}
where $x_{m'}=L_x m' / N_x$ and $z_{n'}=L_z n' / N_z$.  This approximation is
nothing but a quadrature error (see, e.g., theorem~19 in~\cite{Boyd2001}).
With knowledge of the nonlinear operator $\mathscr{N}$, such quadrature error
can be mitigated via an appropriate dealiasing technique (see,
e.g.,~\cite{Canuto2006}).  Interestingly, our weighted residual
\eqref{eq:R_h_weighted_residual_zero} need now only be zero in this weaker,
discrete sense.  We are left with $N_x\times{}N_z$ time-dependent systems
containing $N_y$ equations coupled in the $x$ and $z$ directions only through
discrete Fourier transforms and the requirements of the $\mathscr{L}$ and
$\mathscr{N}$ operators.

Calling $\hat{u}_{l m n}(t)$ the wave space coefficients of the solution at
some time $t$, the nonlinear portion of \eqref{eq:spatial_discretization} may
be efficiently computed by
\begin{enumerate}
 \item performing $\mathcal{O}\!\left(m\times{}n\right)$ matrix-vector products
       like $\sum_{l} B_l\!\left(y_{l'}\right) \hat{u}_{l m n}(t)$,
 \item using an inverse fast Fourier transform across
       the $x$ and $z$ directions to convert state information from wave space
       to physical space,
 \item applying the nonlinear operator $\mathscr{N}$ in physical space, and
 \item using a forward fast Fourier transform across the $x$ and $z$
       directions to convert information from physical space to wave space.
\end{enumerate}
Note that the left hand side of \eqref{eq:spatial_discretization} contains a
time-independent mass matrix arising from the B-spline basis and collocation
point choices.  We retain the mass matrix on the same side as the time
derivative in anticipation of the time discretization scheme.  The
computational cost of the scaling factor $\left(N_x N_z\right)^{-1}$
can be hidden within the time advancement scheme.

Rather than time advancing the B-spline coefficients $\hat{u}_{l m n}(t)$ as
state, one could instead instead advance the wavenumber-dependent collocation
point values $\hat{u}_{y_{l'} m n}(t) = \sum_{l} B_l\!\left(y_{l'}\right)
\hat{u}_{l m n}(t)$.  Then \eqref{eq:spatial_discretization} would become
\begin{align}
  \frac{\partial}{\partial{}t} \hat{u}_{y_{l'} m n}(t)
  &\approx
  \mathscr{L}\left(\hat{u}_{y_{l'} m n}(t)\right)
  +
  \frac{1}{N_x N_z}
  \sum_{m'} \sum_{n'}
  \mathscr{N}\left(
    \sum_{m}
    \sum_{n}
    \hat{u}_{y_{l'} m n}(t)
    e^{\ii k_m x_{m'}}e^{\ii k_n z_{n'}}
  \right)
  \left(
    e^{-\ii k_{m'} x_m}e^{-\ii k_{n'} z_n}
  \right)
  .
  \label{eq:spatial_discretization_gridpoints}
\end{align}
Equation \eqref{eq:spatial_discretization_gridpoints} is obviously simpler than
equation \eqref{eq:spatial_discretization}.  In particular, it lacks a mass
matrix in the time derivative term.

\subsection{Time discretization}
\label{sec:timediscretization}

We use Spalart, Moser, and Rogers' low storage hybrid implicit/explicit
time stepper from appendix A of~\cite{spalart_lowstoragerk}.  This time stepper
advances the system
\begin{align}
 u_t &= Lu + N(u,t)
\end{align}
from $u(t)$ to $u\left( t+\Delta{}t \right)$.  Here $L$ and $N$ are a linear
and nonlinear operator, respectively, distinct from but related to the
preceding section's $\mathscr{L}$ and $\mathscr{N}$ (see
\textsection\ref{sec:combineddiscretization} for the exact relationships).  The
operator $L$ must be time-independent throughout each interval $\left[t,
t+\Delta{}t\right)$.  In contrast to the discussion
in~\cite{spalart_lowstoragerk} and following S. Yang (personal communication),
we allow $N$ to vary in time.  The ``SMR91'' scheme advances according to the
following equations:
\begin{subequations}
\begin{align}
  u'
  &=
  u_{n}
  + \Delta{}t\left[
      L\left( \alpha_{1}u_{n} + \beta_{1}u' \right)
    + \gamma_{1} N\left(u_{n},t_{n}\right)
  \right]
  \tag{SMR91 A4a}
  \label{eq:SMR91_A4a}
\\
  u''
  &=
  u'
  + \Delta{}t\left[
    L\left( \alpha_{2}u' + \beta_{2}u'' \right)
    + \gamma_{2} N\left(u',t_{n}+\eta_{2}\Delta{}t\right)
    + \zeta_{1}  N\left(u_{n},t_{n}\right)
  \right]
  \tag{SMR91 A4b}
  \label{eq:SMR91_A4b}
\\
  u_{n+1}
  &=
  u''
  + \Delta{}t\left[
      L\left( \alpha_{3}u'' + \beta_{3}u_{n+1} \right)
    + \gamma_{3} N\left(u'',t_{n}+\eta_{3}\Delta{}t\right)
    + \zeta_{2}  N\left(u',t_{n}+\eta_{2}\Delta{}t\right)
  \right]
  \tag{SMR91 A4c}
  \label{eq:SMR91_A4c}
\end{align}
\begin{align}
  \alpha_1 + \beta_1 &= \gamma_1 = \eta_2
  &
  \alpha_2 + \beta_2 &= \gamma_2 + \zeta_1
  &
  \alpha_3 + \beta_3 &= \gamma_3 + \zeta_2
  &
  \eta_{3} &= \eta_2 + \alpha_2 + \beta_2
  \tag{SMR91 A5}
\end{align}
\end{subequations}
The authors determined suitable values for the above coefficients to be
\begin{align*}
  \alpha_1, \alpha_2, \alpha_3 &= \left\{
    \frac{29}{96}, -\frac{3}{40},  \frac{1}{6}
  \right\}
  &
  \beta_1, \beta_2, \beta_3 &= \left\{
    \frac{37}{160}, \frac{5}{24}, \frac{1}{6}
  \right\}
  &
  \gamma_1, \gamma_2, \gamma_3 &= \left\{
    \frac{8}{15}, \frac{5}{12}, \frac{3}{4}
  \right\}
\end{align*}
\begin{align*}
  \zeta_0, \zeta_1, \zeta_2 &= \left\{
    0, -\frac{17}{60}, -\frac{5}{12}
  \right\}
  &
  \eta_0, \eta_1, \eta_2, \eta_3 &= \Biggl\{
    0, 0, \frac{8}{15}, \frac{2}{3}
  \Biggr\}
\end{align*}
We have added $\zeta_0$ and $\eta_0$ for notational convenience.  The
$\eta_{1}$--$\eta_{3}$ coefficients used to extend the SMR91 scheme for
time-dependent $N$ are discussed by Yang~\cite{ShanYang2011}.  Each substep
\eqref{eq:SMR91_A4a}--\eqref{eq:SMR91_A4c} has the general form
\begin{align}
  u^{i+1} &= u^i + \Delta{}t \left[
        \alpha_{i} L u^i
      + \beta_{i}  L u^{i+1}
      + \gamma_{i} N\left( u^{i}, t_{n}+\eta_{i}\Delta{}t \right)
      + \zeta_{i-1} N\left( u^{i-1}, t_{n}+\eta_{i-1}\Delta{}t \right)
  \right]
  \label{eq:generalsubstep}
\end{align}
where $i\in\left\{ 1,2,3 \right\}$ is the substep number.
We rewrite the general substep equation as
\begin{align}
  \left(I - \Delta{}t\beta_{i}L\right) u^{i+1}
  &=
  \left(I + \Delta{}t\alpha_{i}L\right) u^{i}
  + \Delta{}t\gamma_{i}N\left(u^{i}, t_{n}+\eta_{i}\Delta{}t\right)
  + \Delta{}t\zeta_{i-1}N\left(u^{i-1}, t_{n}+\eta_{i-1}\Delta{}t\right)
  \label{eq:generaloperatorsubstep}
  .
\end{align}
The scheme treats $N$ with third-order accuracy and $L$ with second-order
accuracy.  See both the top of page 323 in~\cite{spalart_lowstoragerk} and
chapter 7 in~\cite{ShanYang2011} for more accuracy-related details.

We wish to advance problems like $Mu_{t}=\tilde{L}u+\chi\tilde{N}\left( u,t
\right)$ where $\chi$ is a time-independent scalar and both $\tilde{L}$ and
$\tilde{N}$ take state values to some non-state representation which can be
converted back to state by the linear ``mass matrix'' operator $M$.  Then by
$L=M^{-1}\tilde{L}$ and $N=\chi{}M^{-1}\tilde{N}$ the general substep equation
gives
\begin{align}
  \left(I - \Delta{}t\beta_{i}M^{-1}\tilde{L}\right) u^{i+1}
  &=
  \left(I + \Delta{}t\alpha_{i}M^{-1}\tilde{L}\right) u^{i}
\\
  &+ \Delta{}t\gamma_{i}\chi{}M^{-1}
    \tilde{N}\left(u^{i}, t_{n}+\eta_{i}\Delta{}t\right)
  + \Delta{}t\zeta_{i-1}\chi{}M^{-1}
    \tilde{N}\left(u^{i-1}, t_{n}+\eta_{i-1}\Delta{}t\right)
  .
\end{align}
We multiply through by $M$ to obtain
\begin{align}
  \left(M - \Delta{}t\beta_{i}\tilde{L}\right) u^{i+1}
  &=
  \left(M + \Delta{}t\alpha_{i}\tilde{L}\right) u^{i}
  + \Delta{}t\gamma_{i}\chi{}
    \tilde{N}\left(u^{i}, t_{n}+\eta_{i}\Delta{}t\right)
  + \Delta{}t\zeta_{i-1}\chi{}
    \tilde{N}\left(u^{i-1}, t_{n}+\eta_{i-1}\Delta{}t\right)
  \label{eq:generaloperatormasssubstep}
\end{align}
which is just \eqref{eq:generaloperatorsubstep} with $M$ replacing $I$,
$\tilde{L}$ replacing $L$, and $\chi{}\tilde{N}$ replacing $N$.  We now drop
the tildes on $L$ and $N$ with the understanding that they are implied whenever
$M\neq{}I$.

The time advancement scheme in \eqref{eq:generaloperatormasssubstep} requires
implementations of $u\mapsto{}{N}\left(u\right)$,
$u\mapsto{}\left(M+\varphi{}L\right)u$, and
$u\mapsto{}\left(M+\varphi{}L\right)^{-1}u$ for a given $M$ and some arbitrary
scalar $\varphi$.  To achieve a low storage implementation, the
$N\left(u\right)$ and $\left(M+\varphi{}L\right)^{-1}$ implementations must
operate in-place while $\left(M+\varphi{}L\right)$ must operate out-of-place.
Given only two storage locations $a$ and $b$, each substep computation follows
algorithm~\vref{alg:substep}.

\begin{algorithm}
\label{alg:substep}
\caption{Compute one substep in the SMR91 scheme following
         equation (\ref{eq:generaloperatormasssubstep}) %FIXME \eqref?
         }
\begin{algorithmic}
  \REQUIRE Storage $a = u^i$;
           storage $b = N\left(u^{i-1},t_{n}+\eta_{i-1}\Delta{}t\right)$
  \STATE $b\leftarrow{}   \left(M+\Delta{}t\alpha_{i}L\right)a
                        + \Delta{}t\zeta_{i-1}\chi{}b$
  \STATE $a\leftarrow{}N\left(a,t_{n}+\eta_{i}\Delta{}t\right)$
  \STATE $b\leftarrow{}\Delta{}t\gamma_{i}\chi{}a + b$
  \STATE $b\leftarrow{}\left(M-\Delta{}t\beta_{i}L\right)^{-1}b$
  \ENSURE Storage $a = N\left(u^{i},t_{n}+\eta_{i}\Delta{}t\right)$;
          storage $b = u^{i+1}$
\end{algorithmic}
\end{algorithm}

Two possible issues arise when repeatedly using the substep algorithm: First,
during the first substep the step size $\Delta{}t$ may need to be computed
dynamically based on a stability criterion available only during the nonlinear
operator computation.  Second, it may be important to always apply each
operator against a particular storage location.  This requirement implies that
the implementation of $\left(M+\varphi{}L\right)$ must also support in-place
application.  For the second and subsequent substeps, either
$\left(M+\varphi{}L\right)$ must support a decidedly non-BLAS-like, complicated
out-of-place-apply-and-swap operation or the underlying state storage must
support a swap operation.  We choose the latter and denote the swap operation
as $a\leftrightarrow{}b$.  Under these considerations, time step computation
follows algorithm~\vref{alg:step}.

\begin{algorithm}
\caption{Compute all substeps in the SMR91 scheme following
         equation (\ref{eq:generaloperatormasssubstep}) % FIXME \eqref?
         }
\label{alg:step}
\begin{algorithmic}
  \renewcommand{\algorithmiccomment}[1]{\hfill{}// #1}
  \REQUIRE Storage $a = u\left(t_{n}\right) = u^{0} $;
           storage $b$ content undefined
  \STATE $b\leftarrow{}a$
  \STATE $b\leftarrow{}N\left(b,t_{n}\right)$
  \STATE Compute $\Delta{}t$ from $a=u^0$ and $b=N\left(u^0,t_{n}\right)$
  \STATE $a\leftarrow{}\left(M+\Delta{}t\alpha_{1}L\right)a$
  \STATE $a\leftarrow{}\Delta{}t \gamma_{1} \chi{} b + a$
  \STATE $a\leftarrow{}\left(M-\Delta{}t\beta_{1}L\right)^{-1}a$
  \ENSURE Storage $a = u^1$;
          storage $b = N\left(u^{0},t_{n}\right)$
  \STATE $b\leftarrow{}   \left(M+\Delta{}t\alpha_{2}L\right)a
                        + \Delta{}t\zeta_{1}\chi{}b$
  \STATE $a\leftrightarrow{}b$
  \STATE $b\leftarrow{}N\left(b,t_{n}+\eta_{2}\Delta{}t\right)$
  \STATE $a\leftarrow{}\Delta{}t \gamma_{2} \chi{} b + a$
  \STATE $a\leftarrow{}\left(M-\Delta{}t\beta_{2}L\right)^{-1}a$
  \ENSURE Storage $a = u^{2}$;
          storage $b = N\left(u^{1},t_{n}+\eta_{2}\Delta{}t\right)$
  \STATE $b\leftarrow{}   \left(M+\Delta{}t\alpha_{3}L\right)a
                        + \Delta{}t\zeta_{2}\chi{}b$
  \STATE $a\leftrightarrow{}b$
  \STATE $b\leftarrow{}N\left(b,t_{n}+\eta_{3}\Delta{}t\right)$
  \STATE $a\leftarrow{}\Delta{}t \gamma_{3} \chi{}b + a$
  \STATE $a\leftarrow{}\left(M-\Delta{}t\beta_{3}L\right)^{-1}a$
  \ENSURE Storage $a = u\left(t+\Delta{}t\right)= u^{3}$;
          storage $b = N\left(u^{2},t_{n}+\eta_{3}\Delta{}t\right)$
\end{algorithmic}
\end{algorithm}

\subsection{Combined space and time discretization}
\label{sec:combineddiscretization}

Using \eqref{eq:generaloperatormasssubstep} to advance state
$\hat{u}_{l m n}(t)$ following \eqref{eq:spatial_discretization} gives
the time-independent discrete operators
\begin{subequations}
\begin{align}
   M u\bigr|_{m n}
&= \sum_{l} B_l\!\left(y_{l'}\right)
   \hat{u}_{l m n}
\\
   \left.\tilde{L} u\right|_{m n}
&= \mathscr{L}\left(
     \sum_{l}
     B_l\!\left(y_{l'}\right)
     \hat{u}_{l m n}
   \right)
\\
   \left.\tilde{N}\!\left(u\right)\right|_{m n}
&= \underbrace{\frac{1}{N_x N_z}}_{\chi}
   \sum_{m'} \sum_{n'}
   \mathscr{N}\left(
     \sum_{m}
     \sum_{n}
     \left(
       \sum_{l} B_l\!\left(y_{l'}\right)
       \hat{u}_{l m n}
     \right)
     e^{\ii k_m x_{m'}}e^{\ii k_n z_{n'}}
   \right)
   \left(
     e^{-\ii k_{m'} x_m}e^{-\ii k_{n'} z_n}
   \right)
\end{align}
\end{subequations}
while advancing state $\hat{u}_{y_{l'} m n}(t)$ following
\eqref{eq:spatial_discretization_gridpoints} instead fixes the operators as
\begin{subequations}
\begin{align}
   M u\bigr|_{m n}
&= \hat{u}_{y_{l'} m n}
\\
   \left.\tilde{L} u\right|_{m n}
&= \mathscr{L}\left(\hat{u}_{y_{l'} m n}\right)
\\
   \left.\tilde{N}\!\left(u\right)\right|_{m n}
&= \underbrace{\frac{1}{N_x N_z}}_{\chi}
   \sum_{m'} \sum_{n'}
   \mathscr{N}\left(
     \sum_{m}
     \sum_{n}
     \hat{u}_{y_{l'} m n}
     e^{\ii k_m x_{m'}}e^{\ii k_n z_{n'}}
   \right)
   \left(
     e^{-\ii k_{m'} x_m}e^{-\ii k_{n'} z_n}
   \right)
   .
\end{align}
\end{subequations}
When following \eqref{eq:spatial_discretization} the operators $\tilde{L}$ and
$\tilde{N}$ take B-spline coefficients as input and return collocation point
values.  When following \eqref{eq:spatial_discretization_gridpoints} the
operators both take and return collocation point values.  We choose to work
with \eqref{eq:spatial_discretization} because it provides computational
advantages.  For a discussion on moving operators between these two
representations, see \textsection{}5.5 in~\cite{Boyd2001}.

\subsection{Forming discrete operators}
\label{sec:formingoperators}

Consistent with employing \eqref{eq:spatial_discretization}, discrete operators
for differentiation in the wall-normal direction map B-spline coefficients to
derivatives at wall-normal collocation points.  That is,
\begin{align}
  D^{(k)} u\bigr|_{m n}
&= \sum_{l} B^{(k)}_l\!\left(y_{l'}\right)
   \hat{u}_{l m n}
\end{align}
where the banded matrix $D^{(k)}$ is wavenumber independent.  $D^{(0)}$ is
nothing but the ``mass matrix'' $M$.  Boundary conditions may be enforced for
B-spline derivatives by using that the $k$th derivative of the function at the
first (last) collocation point depends only on the first (last) $k+1$ B-spline
coefficients.

Computing the streamwise (or spanwise) first derivative of a quantity only
requires multiplying each Fourier expansion coefficient $\hat{u}_{l m n}$ by
$\ii k_{m}$ (or~$\ii k_{n}$).  Second derivatives are found by multiplying each
$\hat{u}_{l m n}$ by $-k_{m}^2$ (or~$-k_{n}^2$).

Combining the B-spline and Fourier details for a scalar-valued $\phi$ one finds
\begin{align}
  \left.\left(\nabla{} \phi\right)\right|_{m n}
&=
  \begin{pmatrix}
    \ii k_m M \\
    D^{(1)}   \\
    \ii k_n M
  \end{pmatrix} \phi\bigr|_{m n}
\\
   \left.\left(\Delta{} \phi\right)\right|_{m n}
&= \left( -\left(k_m^2 + k_n^2\right)M + D^{(2)} \right) \phi\bigr|_{m n}
\\
  \left.\left(\nabla\nabla{} \phi\right)\right|_{m n}
&=
  \begin{pmatrix}
    -k_m^2               M       & \ii k_m D^{(1)} & \ii \left(k_m + k_n\right) M \\
    \ii k_m              D^{(1)} &         D^{(2)} & \ii k_n D^{(1)}        \\
    \ii \left(k_m + k_n\right) M       & \ii k_n D^{(1)} & -k_n^2 M
  \end{pmatrix} \phi\bigr|_{m n}
\end{align}
where all operators map coefficients in all three directions to wall-normal
collocation point values but streamwise and spanwise coefficients.  For a
vector field $\vec{\phi}=\trans{\begin{pmatrix}\phi_{x} & \phi_{y} &
 \phi_{z}\end{pmatrix}}$ one obtains the following:
\begin{align}
  \left.\nabla\cdot\vec{\phi}\right|_{m n}
&=
  \left.\left(\ii k_m M \phi_{x} + D^{(1)} \phi_{y} + \ii k_n M \phi_{z}\right)\right|_{m n}
\\
  \left.\nabla\vec{\phi}\right|_{m n}
&=
  \left.\begin{pmatrix}
    \ii k_m M \phi_{x} & D^{(1)} \phi_{x} & \ii k_n M \phi_{x} \\
    \ii k_m M \phi_{y} & D^{(1)} \phi_{y} & \ii k_n M \phi_{y} \\
    \ii k_m M \phi_{z} & D^{(1)} \phi_{z} & \ii k_n M \phi_{z}
  \end{pmatrix}\right|_{m n}
\\
  \left.\Delta\vec{\phi}\right|_{m n}
&=
  \left.\begin{pmatrix}
    \left( -\left(k_m^2 + k_n^2\right)M + D^{(2)} \right) \phi_{x} \\
    \left( -\left(k_m^2 + k_n^2\right)M + D^{(2)} \right) \phi_{y} \\
    \left( -\left(k_m^2 + k_n^2\right)M + D^{(2)} \right) \phi_{z}
  \end{pmatrix}\right|_{m n}
\\
  \left.\nabla\nabla\cdot\vec{\phi}\right|_{m n}
&=
  \left.\begin{pmatrix}
    - k_m^2 M \phi_{x}       + \ii k_m D^{(1)} \phi_{y} + \ii \left(k_m + k_n\right) M \phi_{z} \\
    \ii k_m D^{(1)} \phi_{x} + D^{(2)} \phi_{y} + \ii k_n D^{(1)} \phi_{z} \\
    \ii \left(k_m + k_n\right) M \phi_{x} + \ii k_n D^{(1)} \phi_{y} - k_n^2 M \phi_{z}
  \end{pmatrix}\right|_{m n}
\end{align}
The operator $\nabla\times\nabla\times\vec{\phi} = \nabla\nabla\cdot\vec{\phi}
- \Delta\vec{\phi}$, which may be expanded as
\begin{align}
  \left.\nabla\times\nabla\times\vec{\phi}\right|_{m n}
&=
  \left.\begin{pmatrix}
    \left(k_n^2 M - D^{(2)}\right) \phi_{x} + \ii k_m D^{(1)} \phi_{y} + \ii \left(k_m+k_n\right) M \phi_{z} \\
    \ii k_m D^{(1)} \phi_{x} + \left(k_n^2 + k_m^2\right)M \phi_{y} + \ii k_n D^{(1)} \phi_{z} \\
    \ii \left(k_m + k_n\right) M \phi_{x} + \ii k_n D^{(1)} \phi_{y} + \left(k_m^2 M - D^{(2)}\right) \phi_{z}
  \end{pmatrix}\right|_{m n}
  ,
\end{align}
is interesting because it looks ``antidiffusive'' in the sense that all
strictly second order terms have signs opposite those found in the Laplacian.
By employing the Helmholtz decomposition and modest smoothness assumptions, one
may show $\nabla\times\nabla\times\vec{\phi}$ is nothing but a negated
Laplacian acting on only the solenoidal portion of $\vec{\phi}$.

We comment that while the Fourier bases are discretely conservative, the
B-spline basis is not in general.  However, the relative discrete conservation
error in the wall normal direction is small enough that using a conservative
continuous formulation remains worthwhile.

\subsection{Time step stability criteria}
\label{sec:stabilitycriteria}

The step size $\Delta{}t$ used within the SMR91 scheme is limited by both a
convective and a diffusive stability criteria.  The time step used is taken to
be the minimum stable time step possible according to either restriction.  As
both criteria are approximate, the resulting $\Delta{}t$ is further multiplied
by a value less than one as a way to introduce a safety factor.  Values like
$0.70-0.72$ are often used.

\subsubsection{Convective stability criterion}
\label{sec:convectivestability}

The convective criterion uses the maximum imaginary eigenvalue magnitude from
the Euler equations as a surrogate for the more complicated Navier--Stokes
case.  Both Kwok~\cite{Kwok2002} (equation~2.39) and Guarini~\cite{Guarini1998}
(equations~4.20 and~4.21) derive the dimensional stability result that
\begin{align}\label{eq:convectivestability}
  \pi\left(
      \frac{\left|u_{x}\right| + a}{\Delta{}x}
    + \frac{\left|u_{y}\right| + a}{\Delta{}y}
    + \frac{\left|u_{z}\right| + a}{\Delta{}z}
  \right) \Delta{}t \leq \left|\lambda_{I}\Delta{}t\right|_{\mbox{max}}
\end{align}
where $a$ is the local acoustic velocity, $u_{x}$ denotes the velocity in the X
direction, $\Delta{}x$ represents the local grid size in the X direction, etc.
The maximum pure imaginary eigenvalue magnitude,
$\left|\lambda_{I}\Delta{}t\right|_{\mbox{max}}$, is a feature of the chosen
timestepping method.  For the SMR91 scheme,
\begin{align}
  \left|\lambda_{I}\Delta{}t\right|_{\mbox{max}} &= \sqrt{3}.
\end{align}

For nondimensional formulations like ours in which an explicit Mach number
$\mbox{Ma}=\frac{u_0}{a_0}$ appears, one must provide the velocities and the
sound speed both nondimensionalized using $u_0$.  That expressions like
$\left|u\right| + \frac{a}{\mbox{Ma}}$ are appropriate in that context can be
seen by finding the eigenvalues of the Euler equations in such a
nondimensionalization.  Using a hybrid implicit/explicit time scheme, like
SMR91, where acoustic terms treated implicitly effectively sets the sound speed
to be zero when computing this convective criterion.

When Venugopal~\cite{Venugopal2003} used a nearly identical convective
criterion (equation~3.10), he found the constraint to be overly conservative in
the wall-normal direction because its derivation (incorrectly) assumes a
periodic wall-normal basis.  Venugopal (section~3.2) presents a linearized
analysis taking into account the inhomogeneous nature of the wall-normal
direction.  He determined that the wall-normal imaginary eigenvalue magnitude
dropped by nearly an order of magnitude after taking into account the
inhomogeneity (i.e., using discrete operators like those in
section~\ref{sec:formingoperators}).  He concluded that using an effective
$1/\Delta{}y$ four times smaller than the nominal value was feasible
(equation~3.29).

\subsubsection{Diffusive stability criterion}

The diffusive criterion uses the maximum real eigenvalue magnitude from a model
diffusion equation as a surrogate for the more complicated Navier--Stokes case.
Both Kwok~\cite{Kwok2002} (equations~2.40) and Guarini~\cite{Guarini1998}
(equations~4.29 and~4.30) derive the dimensional stability result that
\begin{align}\label{eq:diffusivestability}
    \mbox{max}\!\left(
      \left|\frac{\gamma\left(\nu-\nu_{0}\right)}{\mbox{Re}\mbox{Pr}}\right|,
      \left|\frac{\nu-\nu_{0}}{\mbox{Re}}\right|,
      \left|\frac{\nu_{B}-\nu_{B0}}{\mbox{Re}}\right|
    \right)
    \pi^{2}
    \left(
        \frac{1}{\Delta{}x^{2}}
      + \frac{1}{\Delta{}y^{2}}
      + \frac{1}{\Delta{}z^{2}}
    \right)
    \Delta{}t \leq \left|\lambda_{R}\Delta_{}t\right|_{\mbox{max}}
\end{align}
where a bulk kinematic viscosity has been added to their results.  The maximum
pure real eigenvalue magnitude,
$\left|\lambda_{R}\Delta{}t\right|_{\mbox{max}}$, is a feature of the chosen
timestepping method.  For the SMR91 scheme,
\begin{align}
\left|\lambda_{R}\Delta{}t\right|_{\mbox{max}} &\approx 2.512.
\end{align}
Using a hybrid implicit/explicit time scheme, like SMR91, with viscous terms
treated implicitly sets $\nu_0$ to be the reference kinematic viscosity
about which the viscous terms were linearized.  The absolute values within the
maximum operation account for the possibility that $\nu<\nu_{0}$.

Venugopal~\cite{Venugopal2003} used a nearly identical diffusive criterion
(equation~3.15).  His analysis determined that the diffusive stability
criterion was not overly conservative for a non-periodic B-spline
discretization.

\section{Numerical considerations}

Here we take the complete mathematical model from section \ref{sec:derivation}
and put it into the form which we will compute per section
\ref{sec:discretization}.  Though less clean in appearance, this section's
equations will better reflect the spectral implementation details used in
Suzerain than those given in earlier sections.

\subsection{Convective derivative operator form}

We choose to use the conservative form of the convective derivative operator,
$\nabla\cdot\left(u\otimes{}\rho{}u\right)$, instead of the skew-symmetric
form, $\frac{1}{2}u\cdot\nabla{}\rho{}u +
\frac{1}{2}\nabla\cdot{}u\otimes{}\rho{}u$.  The former is simpler to compute,
retains the conservative nature of the equations, and behaves comparably to the
latter in the incompressible case when aliasing errors are
removed~\cite{Zang1991Rotation}.  This choice may need to be revisited as the
wall-normal direction is not dealiased.

\subsection{State variable selection}
\label{state_variable_selection}

We use nondimensional density $\rho$, momentum $m=\rho{}u$, and total energy
$e=\rho{}E$ as the state variables for our computations.  Though it
eliminates division and potentially allows for fully dealiased calculations, we
do not use specific density $\sigma=1/\rho$ because it requires using a
nonconservative mass equation.  When rewritten using the state variables
the equations in section~\ref{nondim_equations} become
\begin{subequations}
\begin{align}
  \label{eq:state_continuity}
  \frac{\partial}{\partial{}t}\rho{}
&=
  - \nabla\cdot{}m
  \\
  \label{eq:state_momentum}
  \frac{\partial}{\partial{}t}m
&=
  - \nabla\cdot\left(\frac{m}{\rho}\otimes{}m\right)
  - \frac{1}{\Mach^{2}} \nabla{} p
  + \frac{1}{\Reynolds} \nabla\cdot\tau
  + f
  \\
  \label{eq:state_energy}
  \frac{\partial}{\partial{}t} e
&=
  - \nabla\cdot{}\left(e + p\right)\frac{m}{\rho}
  + \frac{1}{\Reynolds\,\Prandtl\,\left( \gamma - 1 \right)}
    \nabla\cdot\mu\nabla{} T
  + \frac{\Mach^{2}}{\Reynolds} \nabla\cdot\tau{}\frac{m}{\rho}
  + \Mach^{2} f \cdot{} \frac{m}{\rho}
  + q_{b}
\intertext{
  where the non-state quantities are fixed by
}
  \label{eq:state_pressure}
  p &= \left(\gamma-1\right) \left( e - \Mach^{2}\frac{m^2}{2\rho} \right)
  \\
  \label{eq:state_temperature}
  T &= \gamma{} \frac{p}{\rho}
  \\
  \label{eq:state_viscosity}
  \mu &= T^{\beta}
  \\
  \label{eq:state_secondviscosity}
  \lambda &= \left(\alpha- \frac{2}{3}\right) \mu
  \\
  \label{eq:state_viscousstress}
  \tau &= 2 \mu \symmetricpart{\nabla{}\frac{m}{\rho}}
        + \lambda\left(\nabla\cdot{}\frac{m}{\rho}\right) I
\end{align}
\end{subequations}
and we have employed the notation
$\symmetricpart{A}=\frac{1}{2}\left(A+\trans{A}\right)$.

\subsection{Communications overhead}
\label{sec:commoverhead}

As detailed in section~\ref{sec:combineddiscretization}, we perform time
advancement in wave space but must compute nonlinear terms in physical space.
The communications and computation cost required to convert state data from
wave space to physical space or vice versa is very high.  Consequently, we
transform back and forth only once per time integration substep.

\subsection{Velocity derivative expansions}
\label{velocity_derivative_expansions}

Because we transform to and from physical space only once per substep, we must
be able to compute derived quantity derivatives using only state derivatives.
We expand several velocity derivatives into a combination of terms each
containing derivative operators applied only to state quantities:
\begin{subequations}
\begin{align}
  \nabla\cdot\frac{m}{\rho}
  &=
  \rho^{-1}\left[ \nabla\cdot{}m - \rho^{-1}m\cdot\nabla\rho \right]
\\
  \nabla{}\frac{m}{\rho}
  &=
  \rho^{-1}\left[ \nabla{}m - \rho^{-1}{m}\otimes\nabla\rho  \right]
\\
  \symmetricpart{\nabla\frac{m}{\rho}}
  &=
  \rho^{-1}\left[
      \symmetricpart{\nabla{}m}
    - \symmetricpart{\rho^{-1}m\otimes\nabla\rho}
  \right]
\\
  \Delta\frac{m}{\rho}
  &=
 \rho^{-1}\left[
      \Delta{}m
    + \rho^{-1}\left[
          \left(
              2\rho^{-1}\left(\nabla\rho\right)^{2}
            - \Delta\rho
          \right) {m}
        - 2 \left(\nabla{}m\right)\nabla\rho
      \right]
 \right]
\\
  \nabla\nabla\cdot\frac{m}{\rho}
  &=
  \rho^{-1}\left[
        \nabla\nabla\cdot{}m
      + \rho^{-1}\left[
            \left(2\rho^{-1}\nabla\rho\cdot{}m-\nabla\cdot{}m\right)\nabla\rho
          - \left(\nabla\nabla\rho\right)m
          - \trans{\nabla{}m}\nabla\rho
        \right]
  \right]
\\
  \nabla\times\nabla\times\frac{m}{\rho}
  &=
  \rho^{-1}\left[
        \nabla\times\nabla\times{}{m}
      + \rho^{-1} \left[
            \left(2\nabla{}m - \trans{\nabla{}m} \right) \nabla\rho
          + \left(\Delta\rho - 2 \rho^{-1} \left(\nabla\rho\right)^2 \right) m
        \right.
  \right.
\\ % continued...
  &\qquad\qquad\qquad\qquad\qquad
  \left.
      \left.
          - \left(\nabla\nabla\rho \right) m
          + \left(2\rho^{-1}\nabla\rho\cdot{}m-\nabla\cdot{}m\right)\nabla\rho
      \right]
  \right]
\end{align}
\end{subequations}

We note some relationships amongst the information appearing in such
derivatives:
\begin{align}\label{eq:relationships}
  \Delta\rho
  &=
  \trace\left( \nabla\nabla\rho \right)
&
  \nabla\cdot{}m
  &=
  \trace\left(\nabla{}m\right)
  =
  \trace\symmetricpart{\nabla\frac{m}{\rho}}
\end{align}

\subsection{Separation of first and second derivative operators}
\label{sec:separate_first_second_deriv}

Unlike a Fourier basis, for B-splines the repeated application of a discrete
first derivative operator gives a result that differs significantly from
applying a discrete second derivative operator.  In particular, repeated first
differentiation severely abates high frequency modes (see figures 2 and 3 in
~\cite{Kwok2001}).

Second differentiation enters equations~\eqref{eq:state_continuity},
\eqref{eq:state_momentum}, and~\eqref{eq:state_energy} through the terms
$\nabla\cdot\tau$, $\nabla\cdot\tau\frac{m}{\rho}$, and
$\nabla\cdot\mu\nabla{}T$.  We wish to compute these terms in a way that keeps
first and second derivative applications wholly separate.  Doing so will help
ensure that these three terms have the most physically correct diffusive impact
on high frequency content at a given spatial resolution.  These results will
also be used in the course of developing our implicit diffusive treatment.

We expand the three mixed order, nonlinear terms:
\begin{align}
\label{eq:nabla_cdot_tau_expansion}
  \nabla\cdot\tau
  &=
    2 \symmetricpart{\nabla\frac{m}{\rho}}\nabla\mu
  + \mu \Delta\frac{m}{\rho}
  + \left(\mu+\lambda\right)\nabla\nabla\cdot\frac{m}{\rho}
  + \left(\nabla\cdot\frac{m}{\rho}\right)\nabla\lambda
\\
\label{eq:nabla_cdot_tau_u_expansion}
  \nabla\cdot\tau{}\frac{m}{\rho}
  &=
    \frac{m}{\rho}\cdot\left(\nabla\cdot\tau\right)
  + \trace\left( \tau\,\nabla\frac{m}{\rho} \right)
\\
  \nabla\cdot\mu\nabla{}T \label{eq:mu_delta_T}
  &=
    \nabla\mu\cdot\nabla{}T
  + \mu \Delta{}T
\end{align}
One may also write
\begin{align}\label{eq:nabla_cdot_tau_expansion_alt}
  \nabla\cdot\tau
  &=
    2 \symmetricpart{\nabla\frac{m}{\rho}}\nabla\mu
  + \left(2\mu+\lambda\right) \Delta\frac{m}{\rho}
  + \left(\mu+\lambda\right)\nabla\times\nabla\times\frac{m}{\rho}
  + \left(\nabla\cdot\frac{m}{\rho}\right)\nabla\lambda
\end{align}
which highlights the isotropic diffusion of velocity within the viscous terms.

Many of the above term contains non-state derivatives which we now expand:
\begin{align}
  \nabla{}p &= (\gamma-1)\left[
        \nabla{}e + \frac{\Mach^{2}}{\rho} \left[
            \frac{m^{2}}{2\rho} \nabla\rho
          - \trans{\nabla{}m}m
        \right]
  \right]
\\
  \nabla{}T &= \frac{\gamma}{\rho}
               \left[ \nabla{}p - \frac{p}{\rho}\nabla\rho \right]
             = \rho^{-1}\left( \gamma\nabla{}p - T\nabla\rho \right)
\\
  \nabla\mu &= \beta{}T^{\beta-1}\nabla{}T
\\
  \nabla\lambda &= \left(\alpha-\frac{2}{3}\right)\nabla\mu
\\
  \Delta{}p
  &=
  \left(\gamma-1\right)\left[
      \Delta{}e
      - \frac{\Mach^{2}}{\rho}\left[
            \trace\left( \trans{\nabla{}m}\nabla{}m \right)
          + m\cdot\Delta{}m
\right.\right. \notag\\ &\qquad\qquad\qquad\qquad \left.\left. % LINE BREAK
        {}- \rho^{-1}\left[
                2\trans{\nabla{}m}m\cdot\nabla{}\rho
              + \frac{1}{2} m^2 \Delta\rho
              - \rho^{-1} m^2 \left(\nabla\rho\right)^{2}
          \right]
      \right]
  \right]
\\
  \Delta{}T
  &=
  \gamma\rho^{-1}\left[
        \Delta{}p
      - \rho^{-1}\left[
            p\Delta{}\rho
          + 2\nabla{}\rho\cdot\left( \nabla{}p - \rho^{-1}p\nabla\rho \right)
      \right]
  \right]
\end{align}

Though we could have found these expressions for only the wall-normal
direction, writing them for the complete $\nabla$ operator allows us to reuse
them later.

\subsection{Implications of a fully explicit treatment}

Though our time advance allows an implicit linear term and our Fourier basis
permits repeated first differentiation, it is useful to examine the
communication costs for a purely explicit implementation.  In this context, all
terms within equations~\eqref{eq:state_continuity}, \eqref{eq:state_momentum},
and~\eqref{eq:state_energy} are formed by $\tilde{N}$ in physical space.
Further, we do not mix derivatives of different orders.  The only linear solve
required uses a wavenumber-independent factorization of the mass matrix $M$.

Using the information in sections~\ref{velocity_derivative_expansions}
and~\ref{sec:separate_first_second_deriv} we tabulate in
table~\vref{tab:nofirstderivnonlinearcost} the specific state variable
derivatives necessary to compute each mixed-derivative nonlinear term and all
of its contributions.  From this table and the equations appearing in
section~\ref{state_variable_selection}, a fully explicit timestepping approach
could compute a single substep at the cost of converting 33 scalar fields from
wave space to physical space, forming 5 scalars representing the right hand
sides of equations~\eqref{eq:state_continuity}--\eqref{eq:state_energy}, and
converting 5 scalar fields back to wave space.

While not nearly as efficient as a hybrid implicit/explicit treatment due
to~\eqref{eq:convectivestability} and~\eqref{eq:diffusivestability}, in
conjunction with Venugopal's wall-normal modification to the convective
stability, a fully explicit treatment does allow slow progress to be made on
small problems.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{table}[p]
\centering
\vspace{1em}
\renewcommand{\arraystretch}{1.40}   % Adds whitespace between rows
\newcommand{\cm}{\checkmark}         % For brevity in the table details
\newcommand{\cd}{\ensuremath{\cdot}} % For brevity in the table details
\begin{tabular}{r|cccc|cccccc|ccc|r}
% 001 & 002 & 003 & 004 & 005 & 006 & 007 & 008 & 009 & 011 & 012 & 013 & 014
&   1 &   3 &   1 &   6 &   3 &   1 &   6 &   9 &   3 &   3 &   1 &   3 &   1
\\
& $\rho$                                              % 01
& $\nabla\rho$                                        % 02
& $\Delta\rho$                                        % 03
& $\nabla\nabla\rho$                                  % 04
& $m$                                                 % 05
& $\nabla\cdot{}m$                                    % 06
& $\symmetricpart{\nabla{}m}$                         % 07
& $\nabla{}m$                                         % 08
& $\Delta{}m$                                         % 09
& $\nabla\nabla\cdot{}m$                              % 11
& $e$                                                 % 12
& $\nabla{}e$                                         % 13
& $\Delta{}e$                                         % 14
\\ \hline
$\nabla\cdot\frac{m}{\rho}$
% 001 & 002 & 003 & 004 & 005 & 006 & 007 & 008 & 009 & 011 & 012 & 013 & 014
& \cm & \cm &     &     & \cm & \cm &     &     &     &     &     &     &
& 8 \\
$\nabla\frac{m}{\rho}$
% 001 & 002 & 003 & 004 & 005 & 006 & 007 & 008 & 009 & 011 & 012 & 013 & 014
& \cm & \cm &     &     & \cm &     &     & \cm &     &     &     &     &
& 16 \\
$\symmetricpart{\nabla\frac{m}{\rho}}$
% 001 & 002 & 003 & 004 & 005 & 006 & 007 & 008 & 009 & 011 & 012 & 013 & 014
& \cm & \cm &     &     & \cm &     & \cm &     &     &     &     &     &
& 13 \\
$\Delta\frac{m}{\rho}$
% 001 & 002 & 003 & 004 & 005 & 006 & 007 & 008 & 009 & 011 & 012 & 013 & 014
& \cm & \cm & \cm &     & \cm &     &     & \cm & \cm &     &     &     &
& 20 \\
$\nabla\nabla\cdot\frac{m}{\rho}$
% 001 & 002 & 003 & 004 & 005 & 006 & 007 & 008 & 009 & 011 & 012 & 013 & 014
& \cm & \cm &     & \cm & \cm & \cd &     & \cm &     & \cm &     &     &
& 25 \\[1.5em]
$p$, $T$, $\mu$, $\lambda$
% 001 & 002 & 003 & 004 & 005 & 006 & 007 & 008 & 009 & 011 & 012 & 013 & 014
& \cm &     &     &     & \cm &     &     &     &     &     & \cm &     &
& 5 \\
$\nabla{}p$, $\nabla{}T$, $\nabla\mu$, $\nabla\lambda$
% 001 & 002 & 003 & 004 & 005 & 006 & 007 & 008 & 009 & 011 & 012 & 013 & 014
& \cm & \cm &     &     & \cm &     &     & \cm &     &     & \cm & \cm &
& 20 \\
$\Delta{}p$
% 001 & 002 & 003 & 004 & 005 & 006 & 007 & 008 & 009 & 011 & 012 & 013 & 014
& \cm & \cm & \cm &     & \cm &     &     & \cm & \cm &     &     &     & \cm
& 21 \\
$\Delta{}T$
% 001 & 002 & 003 & 004 & 005 & 006 & 007 & 008 & 009 & 011 & 012 & 013 & 014
& \cm & \cm & \cm &     & \cm &     &     & \cm & \cm &     & \cm & \cm & \cm
& 25 \\[1.5em]
$\tau$
% 001 & 002 & 003 & 004 & 005 & 006 & 007 & 008 & 009 & 011 & 012 & 013 & 014
& \cm & \cm &     &     & \cm & \cd & \cm &     &     &     & \cm &     &
& 14 \\[1.5em]
$\symmetricpart{\nabla\frac{m}{\rho}} \nabla\mu$
% 001 & 002 & 003 & 004 & 005 & 006 & 007 & 008 & 009 & 011 & 012 & 013 & 014
& \cm & \cm &     &     & \cm &     & \cd & \cm &     &     & \cm & \cm &
& 20 \\
$\mu\Delta\frac{m}{\rho}$
% 001 & 002 & 003 & 004 & 005 & 006 & 007 & 008 & 009 & 011 & 012 & 013 & 014
& \cm & \cm & \cm &     & \cm &     &     & \cm & \cm &     & \cm &     &
& 21 \\
$\left(\mu+\lambda\right)\nabla\nabla\cdot\frac{m}{\rho}$
% 001 & 002 & 003 & 004 & 005 & 006 & 007 & 008 & 009 & 011 & 012 & 013 & 014
& \cm & \cm &     & \cm & \cm & \cd &     & \cm &     & \cm & \cm &     &
& 26 \\
$\left(\nabla\cdot\frac{m}{\rho}\right)\nabla\lambda$
% 001 & 002 & 003 & 004 & 005 & 006 & 007 & 008 & 009 & 011 & 012 & 013 & 014
& \cm & \cm &     &     & \cm & \cd &     & \cm &     &     & \cm & \cm &
& 20 \\
$\nabla\cdot\tau$
% 001 & 002 & 003 & 004 & 005 & 006 & 007 & 008 & 009 & 011 & 012 & 013 & 014
& \cm & \cm & \cd & \cm & \cm & \cd & \cd & \cm & \cm & \cm & \cm & \cm &
& 32 \\[1.5em]
$\frac{m}{\rho}\cdot\left(\nabla\cdot\tau\right)$
% 001 & 002 & 003 & 004 & 005 & 006 & 007 & 008 & 009 & 011 & 012 & 013 & 014
& \cm & \cm & \cd & \cm & \cm & \cd & \cd & \cm & \cm & \cm & \cm & \cm &
& 32 \\
$\trace\left(\tau\nabla\frac{m}{\rho}\right)$
% 001 & 002 & 003 & 004 & 005 & 006 & 007 & 008 & 009 & 011 & 012 & 013 & 014
& \cm & \cm &     &     & \cm & \cd & \cd & \cm &     &     & \cm &     &
& 20 \\
$\nabla\cdot\tau\frac{m}{\rho}$
% 001 & 002 & 003 & 004 & 005 & 006 & 007 & 008 & 009 & 011 & 012 & 013 & 014
& \cm & \cm & \cd & \cm & \cm & \cd & \cd & \cm & \cm & \cm & \cm & \cm &
& 32 \\[1.5em]
$\nabla\mu\cdot\nabla{}T$
% 001 & 002 & 003 & 004 & 005 & 006 & 007 & 008 & 009 & 011 & 012 & 013 & 014
& \cm & \cm &     &     & \cm &     &     & \cm &     &     & \cm & \cm &
& 20 \\
$\mu\Delta{}T$
% 001 & 002 & 003 & 004 & 005 & 006 & 007 & 008 & 009 & 011 & 012 & 013 & 014
& \cm & \cm & \cm &     & \cm &     &     & \cm & \cm &     & \cm & \cm & \cm
& 25 \\
$\nabla\cdot\mu\nabla{}T$
% 001 & 002 & 003 & 004 & 005 & 006 & 007 & 008 & 009 & 011 & 012 & 013 & 014
& \cm & \cm & \cm &     & \cm &     &     & \cm & \cm &     & \cm & \cm & \cm
& 25
\end{tabular}
\vspace{1em}
\caption{
    State variable derivatives and the relative computational cost required to
    completely compute quantities in physical space without using repeated
    first derivative applications.  A check (\checkmark) indicates that a
    quantity is required to compute the given term.  A dot ($\cdot$) indicates
    the quantity is required but it can be computed from other required
    quantities.  Costs are given relative to the cost of transforming a single
    scalar field from wave space to physical space and do not include floating
    point operations. The total cost for each term is found in the rightmost
    column of the table.
}
\label{tab:nofirstderivnonlinearcost}
\end{table}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Hybrid implicit/explicit treatment}

\subsubsection{The need for linearization}

The SMR91 time scheme requires the implicit operator $\tilde{L}$ be linear in
the state variables and time-independent.  Precious little of the
Navier--Stokes operator as written in
equations~\eqref{eq:state_continuity}--\eqref{eq:state_energy} meets these
criteria.  We must carve it up by linearizing about some reference state.  This
approach separates each quantity into an explicitly-treated nonlinear portion
plus a linear contribution that satisfies our implicit operator restrictions.

One example is $\rho^{-1}\Delta{}m = \lessreference{\rho^{-1}}\Delta{}m +
\reference{\rho^{-1}}\Delta{}m$ where $\reference{\rho^{-1}}$ indicates the
term $\rho^{-1}$ evaluated at some reference state.  At one extreme, treating a
three-dimensional reference field is prohibitively expensive but would provide
the longest possible time steps according to~\eqref{eq:convectivestability}
and~\eqref{eq:diffusivestability}.  At the other extreme, a uniform reference
value, which should be chosen from the wall as grid spacing is smallest there,
would have the smallest runtime overhead but would provide the smallest time
step gains.  A good compromise between these extremes is to employ a
one-dimensional reference state profile across the wall-normal direction.

Implicit operator implementation details becomes more complicated when ``off
diagonal'' state derivatives are treated implicitly.  By ``off diagonal'' we
mean derivatives of conserved state appearing on equations other than their
own.  For example, the term $\nabla\cdot{}m$ in~\eqref{eq:state_continuity} or
derivatives of the wall-normal momentum appearing in the streamwise portion
of~\eqref{eq:state_momentum}.  In contrast, an ``on diagonal'' example is the
divergence of total energy appearing within~\eqref{eq:state_energy}.  Handling
off-diagonal terms implicitly is better from the perspective of taking the
largest possible time step while maintaining stability but it incurs both an
associated programming and runtime overhead.

\subsubsection{Linearization of viscous terms}

Because second derivatives give rise to the most restrictive eigenvalues for
timestepping, we focus on how second order terms enter the full operator.  We
take the quantities from sections~\ref{velocity_derivative_expansions}
and~\ref{sec:separate_first_second_deriv} and expand the nonlinear coefficients on
second order terms about reference states.

Beginning with the nonlinear linearization candidates from
\eqref{eq:nabla_cdot_tau_expansion}:
\begin{align}
\label{eq:linearready_delta_u}
\mu\Delta\frac{m}{\rho} &=
    \mu\rho^{-2}\left[
          2\rho^{-1}m\left(\nabla\rho\right)^{2}
        - 2 \left(\nabla{}m\right)\nabla\rho
    \right]
\\
  &{}+ \lessreference{\mu\rho^{-1}} \Delta{}m
     - \lessreference{\mu\rho^{-2}m} \Delta\rho
\\
  &{}+ \reference{\mu\rho^{-1}} \Delta{}m
     - \reference{\mu\rho^{-2}m} \Delta\rho
\\
\label{eq:linearready_grad_div_u}
\left(\mu+\lambda\right)\nabla\nabla\cdot\frac{m}{\rho} &=
   \left(\mu+\lambda\right)\rho^{-2}\left[
       \left(2\rho^{-1}\nabla\rho\cdot{}m-\nabla\cdot{}m\right)\nabla\rho
     - \trans{\nabla{}m}\nabla\rho
   \right]
\\
  &{}+ \lessreference{\left(\mu+\lambda\right)\rho^{-1}} \nabla\nabla\cdot{}m
     - \nabla\nabla\rho \lessreference{\left(\mu+\lambda\right)\rho^{-2}m}
\\
  &{}+ \reference{\left(\mu+\lambda\right)\rho^{-1}} \nabla\nabla\cdot{}m
     - \nabla\nabla\rho \reference{\left(\mu+\lambda\right)\rho^{-2}m}
\end{align}

The term~$\frac{m}{\rho}\cdot\left(\nabla\cdot\tau\right)$ from
expansion~\eqref{eq:nabla_cdot_tau_u_expansion} contains the linearizable
contributions $\frac{m}{\rho} \cdot \mu\Delta\frac{m}{\rho}$ and
$\frac{m}{\rho} \cdot \left(\mu+\lambda\right)\nabla\nabla \cdot
\frac{m}{\rho}$.  We choose to not linearize these possibilities due to the
associated implementation complexity and runtime cost.  Not linearizing these
terms while linearizing their analogues in the momentum equation may require
introducing new terms into the stability criteria set forth
in~\ref{sec:stabilitycriteria}.  This choice may need to be revisited.

%%%Moving on to the candidates from the alternative $\nabla\cdot\tau$
%%%expansion~\eqref{eq:nabla_cdot_tau_expansion_alt}:
%%%\begin{align}
%%%\label{eq:linearready_alt_delta_u}
%%%\left(2\mu+\lambda\right)\Delta\frac{m}{\rho} &=
%%%    \left(2\mu+\lambda\right)\rho^{-2}\left[
%%%          2\rho^{-1}m\left(\nabla\rho\right)^{2}
%%%        - 2 \left(\nabla{}m\right)\nabla\rho
%%%    \right]
%%%\\
%%%  &{}+ \lessreference{\left(2\mu+\lambda\right)\rho^{-1}} \Delta{}m
%%%     - \lessreference{\left(2\mu+\lambda\right)\rho^{-2}m} \Delta\rho
%%%\\
%%%  &{}+ \reference{\left(2\mu+\lambda\right)\rho^{-1}} \Delta{}m
%%%     - \reference{\left(2\mu+\lambda\right)\rho^{-2}m} \Delta\rho
%%%\\
%%%\label{eq:linearready_alt_curl_curl_u}
%%%  \left(\mu+\lambda\right)\nabla\times\nabla\times\frac{m}{\rho} &=
%%%        \left(\mu+\lambda\right) \rho^{-2} \left[
%%%                  \left(2\nabla{}m - \trans{\nabla{}m} \right) \nabla\rho
%%%                - 2 \rho^{-1} \left(\nabla\rho\right)^2 m
%%%                + \left(2\rho^{-1}\nabla\rho\cdot{}m-\nabla\cdot{}m\right)\nabla\rho
%%%            \right]
%%%\\
%%%  &{}+ \lessreference{\left(\mu+\lambda\right)\rho^{-1}  } \nabla\times\nabla\times{}m
%%%\\
%%%  &{}+ \lessreference{\left(\mu+\lambda\right)\rho^{-2} m} \Delta\rho
%%%     - \lessreference{\left(\mu+\lambda\right)\rho^{-2} m} \nabla\nabla\rho
%%%\\
%%%  &{}+ \reference{\left(\mu+\lambda\right)\rho^{-1}  } \nabla\times\nabla\times{}m
%%%     + \reference{\left(\mu+\lambda\right)\rho^{-2} m} \Delta\rho
%%%     - \reference{\left(\mu+\lambda\right)\rho^{-2} m} \nabla\nabla\rho
%%%\end{align}

Finishing with the second order temperature term from
equation~\eqref{eq:mu_delta_T} and its dependencies:
\begin{align}
\Delta{}p =
  &{}- \left(\gamma-1\right)\Mach^{2}\rho^{-1}\left[
             \trace\left(\trans{\nabla{}m}\nabla{}m\right)
           - \rho^{-1}\left[
               2\trans{\nabla{}m}m\cdot\nabla{}\rho
             - \rho^{-1} m^2 \left(\nabla\rho\right)^{2}
           \right]
       \right]
\\
  &{}+ \left(\gamma-1\right)\Delta{}e
     - \left(\gamma-1\right)\Mach^{2}\rho^{-1}m\cdot\Delta{}m
     + \frac{\gamma-1}{2}\Mach^{2}\rho^{-2}m^2 \Delta\rho
\\
\label{eq:linear_ready_delta_T}
\mu\Delta{}T =
  &{}- 2\gamma\mu\rho^{-2}\nabla\rho\cdot
       \left(\nabla{}p-\rho^{-1}p\nabla\rho\right)
     + \gamma\mu\rho^{-1}\Delta{}p
     - \gamma\mu\rho^{-2}p\Delta\rho
\\
=
  &{}- 2\gamma\mu\rho^{-2}\nabla{}\rho\cdot
       \left(\nabla{}p-\rho^{-1}p\nabla\rho\right)
\\
  &{}- \gamma\left(\gamma-1\right)\Mach^{2}\mu\rho^{-2}\left[
             \trace\left(\trans{\nabla{}m}\nabla{}m\right)
           - \rho^{-1}\left[
               2\trans{\nabla{}m}m\cdot\nabla{}\rho
             - \rho^{-1} m^2 \left(\nabla\rho\right)^{2}
           \right]
       \right]
\\
  &{}+ \gamma\left(\gamma-1\right)\lessreference{\mu\rho^{-1}}\Delta{}e
     - \gamma\left(\gamma-1\right)\Mach^{2}
       \lessreference{\mu\rho^{-2}m}\cdot\Delta{}m
\\
  &{}+ \gamma\lessreference{
           \mu\rho^{-2}\left(\left(\gamma-1\right)e-2p\right)
       } \Delta\rho
\\
  &{}+ \gamma\left(\gamma-1\right)\reference{\mu\rho^{-1}}\Delta{}e
     - \gamma\left(\gamma-1\right)\Mach^{2}
       \reference{\mu\rho^{-2}m}\cdot\Delta{}m
     + \gamma\reference{
           \mu\rho^{-2}\left(\left(\gamma-1\right)e-2p\right)
       } \Delta\rho
\end{align}
The final line of each expansion contains linearized, implicit-ready portion.
Note that we will recover an explicit-only operator if we choose identically
zero reference values.

\subsubsection{Linearization of acoustic terms}

We now focus on the first order acoustic terms within the momentum and energy
equations.  In the inviscid limit of the hyperbolic Euler equations, the
pressure gives rise to the acoustic characteristics traveling at speeds
$u\pm{}a$.  Pressure is fundamentally an off-diagonal phenomenon requiring
off-diagonal implicit treatment.

Guarini~\cite{Guarini1998} (page~45) treated the pressure gradient term in the
wall-normal momentum equation and the linearized pressure work term implicitly.
The pressure gradient may be linearized as
\begin{align}
  \nabla{}p &= \left(\gamma-1\right)\Mach^{2}\left(
      \frac{1}{2} \lessreference{m^{2}\rho^{-2}}\nabla\rho
    - \trans{\nabla{}m}\lessreference{\rho^{-1}m}
  \right)
\\
&+ \left(\gamma-1\right) \nabla{}e
 + \frac{\gamma-1}{2}\Mach^{2} \reference{m^{2}\rho^{-2}}\nabla\rho
 - \left(\gamma-1\right)\Mach^{2} \trans{\nabla{}m}\reference{\rho^{-1}m}
 .
\end{align}
The total energy convection and pressure work terms may be linearized as
\begin{align}
\nabla\cdot\left(e+p\right)\frac{m}{\rho} =
   &- \left(\gamma-1\right)\mbox{Ma}^{2}\rho^{-2}m\cdot \trans{\nabla{}m}m
    + \gamma\lessreference{ \rho^{-1}m }\cdot\nabla{}e
  \\
   &+ \lessreference{
        \rho^{-1}\left(e+p\right)
      } \nabla\cdot{}m
  \\
   &+ \lessreference{
        \rho^{-2}m\left(\left(\gamma-1\right)e-2p\right)
      }\cdot\vec{\nabla}\rho
  \\
   &+ \gamma\reference{
        \rho^{-1}m
      }\cdot\nabla{}e
    + \reference{
        \rho^{-1}\left(e+p\right)
      }\nabla\cdot{}m
    + \reference{
        \rho^{-2}m\left(\left(\gamma-2\right)e-2p\right)
      }\cdot\vec{\nabla}\rho
.
\end{align}
We have linearized the two terms together as doing so is algebraically simple
and introduces no additional state derivatives.

\subsubsection{Linearity of the continuity equation}
\label{sec:contconv}

If off-diagonal density and momentum derivatives are computed implicitly,
implicitly treating the convective term $-\nabla\cdot{}m$ in
equation~\eqref{eq:state_continuity} is simple.  Doing so reduces by one the
number of scalar fields needing conversion from physical space to wave space.

\subsubsection{The implicitly-treated terms}
\label{sec:implicitlytreatedterms}

Treating wall-normal acoustics implicitly requires off-diagonal coupling
between the wall-normal momentum and total energy equations.  The incremental
programming cost to further couple the streamwise and spanwise momentum
equations to the total energy equation is comparatively small.  The ability to
treat all directions implicitly for both acoustic and diffusive terms has a
higher runtime cost which should be offset by the larger time stability that
results.  Coupling the density equation reduces the communications overhead at
the expense of on-node work (see section~\ref{sec:contconv}) and further
unifies the programmatic details.  Moreover, so long as the fully coupled
implicit operations can fit in cache, increasing the on-node work to take
larger time steps helps to balance the high communication overhead stemming
from sections~\ref{sec:commoverhead} and~\ref{sec:separate_first_second_deriv}.
Improving the computation to communication ratio should bolster scalability.

Accordingly, we choose to implicitly treat all terms identified as candidates
in the preceding discussion.  In the full context of
equations~\eqref{eq:state_continuity}--\eqref{eq:state_energy} these terms are
\begin{align}
  \frac{\partial}{\partial{}t} \rho{} = &-\nabla\cdot{}m
\\
  \frac{\partial}{\partial{}t} m = \dots
% \underbrace{
   &- \frac{\gamma-1}{2} c^{m}_{\nabla\rho} \nabla\rho
    + \left(\gamma-1\right)\trans{\nabla{}m} \overrightarrow{c^u}
    - \frac{\gamma-1}{\Mach^2}\nabla{}e
% }_{-\Mach^{-1}\nabla{}p}
\\
% \underbrace{
   &- \Reynolds^{-1} \overrightarrow{c^{\nu{}u}} \Delta\rho
    - \Reynolds^{-1} \left(\alpha+\frac{1}{3}\right) \left(\nabla\nabla\rho\right) \overrightarrow{c^{\nu{}u}}
    + \Reynolds^{-1} c^{\nu} \Delta{}m
    + \Reynolds^{-1} \left(\alpha+\frac{1}{3}\right)c^{\nu} \nabla\nabla\cdot{}m
% }_{\Reynolds^{-1}\nabla\cdot\tau}
    + \dots
\\
  \frac{\partial}{\partial{}t} e = \dots
   &- \overrightarrow{c^{e}_{\nabla\rho}} \cdot\vec{\nabla}\rho
    - c^{e}_{\nabla\cdot{}m} \nabla\cdot{}m
    - \gamma \overrightarrow{c^u}\cdot\nabla{}e
    + \frac{\gamma}{\Reynolds\Prandtl\left(\gamma-1\right)}
      c^{e}_{\Delta\rho} \Delta\rho
    - \frac{\gamma\Mach^{2}}{\Reynolds\Prandtl}
      \overrightarrow{c^{\nu{}u}}\cdot\Delta{}m
    + \frac{\gamma}{\Reynolds\Prandtl}c^{\nu}\Delta{}e
    + \dots
\end{align}
where the repeated reference values have physically-motivated superscripts
\begin{align}
  c^{\nu} &= \reference{\rho^{-1}\mu}
&
  \overrightarrow{c^{u}} &= \reference{\rho^{-1}m}
  = \trans{\left(c^{u_x}, c^{u_y}, c^{u_z}\right)}
&
  \overrightarrow{c^{\nu{}u}} &= \reference{\rho^{-2}\mu{}m}
  = \trans{\left(c^{\nu{}u_x}, c^{\nu{}u_y}, c^{\nu{}u_z}\right)}
\end{align}
while the single-use reference values
\begin{align}
  c^{m}_{\nabla\rho} &= \reference{m^{2}\rho^{-2}}
\\
  \overrightarrow{c^{e}_{\nabla\rho}} &= \reference{
        m\rho^{-2}\left(\left(\gamma-2\right)e-2p\right)
  }
  = \trans{\left(
      c^{e_{x}}_{\nabla\rho},
      c^{e_{y}}_{\nabla\rho},
      c^{e_{z}}_{\nabla\rho}
  \right)}
\\
  c^{e}_{\nabla\cdot{}m} &= \reference{
        \rho^{-1}\left(e + p\right)
  }
\\
  c^{e}_{\Delta\rho} &= \reference{
        \mu\rho^{-2}\left(\left(\gamma-1\right)e-2p\right)
  }
\end{align}
have superscripts indicating the relevant equation and
subscripts indicating the associated term.

\subsubsection{Discretization of the implicitly-treated terms}

Following~\eqref{eq:generaloperatormasssubstep} and using results
from~\ref{sec:formingoperators}, we must implement $M+\varphi{}L$ for arbitrary
$\varphi$, $k_m$, and $k_n$. $L$ is nothing but the discrete form of the linear
terms from the previous section.  Notice for any reference values
$c^{\bullet}$ left-multiplying by the diagonal matrix
\begin{align}
  C^{\bullet} &= \begin{bmatrix}
   \left.c^{\bullet}\right|_{y=0} &        & 0 \\
                                  & \ddots &    \\
   0                              &        & \left.c^{\bullet}\right|_{y=L}
   \end{bmatrix}
\end{align}
scales linear operators in a way that accommodates wall-normal variations in
reference quantities.  For example, applying $C^{\nu}D^{(2)}$ rather than
$D^{(2)}$ scales the result at collocation point $y=y_l$ by
$\left.c^{\nu}\right|_{y=y_l}$.

Switching to a blocked matrix representation employing five scalar conserved
state fields, the complete, SMR91-ready discrete operator $M+\varphi{}L$ is
shown in figure~\vref{fig:discreteimplicitop}.  The representation chosen
highlights how the full operator is built from discrete operators applied to
individual state fields.  Applying the operator should not require fully
forming it within a contiguous region.  Inverting the operator likely will.
Though written using submatrices blocked assuming each conserved scalar is
stored contiguously, in the implementation the five conserved scalars may be
interleaved such that the overall operator bandwidth is only five times that of
the B-spline mass matrix $M$.

Strong Dirichlet boundary conditions may be enforced in the usual way.  Neumann
boundary condition implementations are less straightforward.  For simulations
with no mean bulk velocity in the spanwise direction, the reference coefficient
matrices $C^{u_z}$ and $C^{\nu{}u_z}$ may be treated as effectively zero.  This
reduces the required linear algebra.  If desired, the density equation and
density terms in the other equations may removed from the result in
figure~\ref{fig:discreteimplicitop}.  Previous work by did not treat density
implicitly Guarini~\cite{Guarini1998}.  Finally, implicitly handling only the
wall-normal directions may be accomplished by setting $k_{m}$ and $k_{n}$ to
zero.  Doing so results in a wavenumber independent operator requiring
factorization only once per substep.

\begin{sidewaysfigure}
\newcommand{\entry}[1]{}          % Provides comments for subblocks
\newcommand{\C}[2]{C^{#1}_{#2}}   % For brevity below
\newcommand{\D}[1]{D^{(#1)}}      % ditto
\newcommand{\M}{M}                % ditto
\newcommand{\g}{\gamma}           % ditto
\newcommand{\km}{k_{m}}           % ditto
\newcommand{\kn}{k_{n}}           % ditto
\newcommand{\mx}{m_{x}}           % ditto
\newcommand{\my}{m_{y}}           % ditto
\newcommand{\mz}{m_{z}}           % ditto
\newcommand{\vp}{\varphi}         % ditto
\newcommand{\subcoeff}[3]{{       % ditto
   \renewcommand{\arraystretch}{2.0}
   \begin{Bmatrix}{#1}\\{#2}\\{#3}\end{Bmatrix}
}}
\newcommand{\Ma}{\ensuremath{\mbox{\small{}Ma}}}
\renewcommand{\Pr}{\ensuremath{\mbox{\small{}Pr}}}
\renewcommand{\Re}{\ensuremath{\mbox{\small{}Re}}}
{\resizebox{\textwidth}{!}{\begin{minipage}[c]{\textwidth}  % SCALE-TO-FIT
\begin{align*}
\bm{\vp}
\renewcommand{\arraystretch}{6.0} % Adds whitespace between rows
\addtolength{\arraycolsep}{-.1em}
\begin{bmatrix}
% Density row
  \entry{\rho\rho}
  \subcoeff{
      \bm{\frac{1}{\vp}} % M
  }{
  }{
  }
& \entry{\rho\mx }
  \subcoeff{
    - \ii\km
  }{
  }{
  }
& \entry{\rho\my }
  \subcoeff{
  }{
    - 1
  }{
  }
& \entry{\rho\mz }
  \subcoeff{
    - \ii\kn
  }{
  }{
  }
& \entry{\rho{}e }
  0
% Streamwise momentum row
\\\entry{\mx\rho }
  \subcoeff{
      \frac{1-\g}{2}\ii\km\C{\mx}{\nabla\rho}
    + \frac{\left(\alpha+\frac{4}{3}\right)\km^2+\kn^2}{\Re}\C{\nu{}u_x}{}
    - \frac{\alpha+\frac{1}{3}}{\Re}\ii\left(\km+\kn\right)\C{\nu{}u_z}{}
  }{
    - \frac{\alpha+\frac{1}{3}}{\Re}\ii\km\C{\nu{}u_y}{}
  }{
    - \frac{1}{\Re}\C{\nu{}u_x}{}
  }
& \entry{\mx\mx  }
  \subcoeff{
      \bm{\frac{1}{\vp}} % M
    + \left(1-\g\right)\ii\km\C{u_x}{}
    - \frac{\left(\alpha+\frac{4}{3}\right)\km^2+\kn^2}{\Re}\C{\nu}{}
  }{
  }{
      \frac{1}{\Re}\C{\nu}{}
  }
& \entry{\mx\my  }
  \subcoeff{
      \left(1-\g\right)\ii\km\C{u_y}{}
  }{
      \frac{\left(\alpha+\frac{1}{3}\right)}{\Re}\ii\km\C{\nu}{}
  }{
  }
& \entry{\mx\mz  }
  \subcoeff{
      \left(1-\g\right)\ii\km\C{u_z}{}
    + \frac{\left(\alpha+\frac{1}{3}\right)}{\Re}\ii\left(\km+\kn\right)\C{\nu}{}
  }{
  }{
  }
& \entry{\mx{}e  }
  \subcoeff{
      \frac{1-\g}{\Ma^2}\ii\km
  }{
  }{
  }
% Wall-normal momentum row
\\\entry{\my\rho }
  \subcoeff{
      \frac{\km^2+\kn^2}{\Re}\C{\nu{}u_y}{}
  }{
      \frac{1-\g}{2}\C{\my}{\nabla\rho}
    - \frac{\alpha+\frac{1}{3}}{\Re}\ii\left(
         \km\C{\nu{}u_x}{} + \kn\C{\nu{}u_z}{}
      \right)
  }{
    - \frac{\alpha+\frac{4}{3}}{\Re}\C{\nu{}u_y}{}
  }
& \entry{\my\mx  }
  \subcoeff{
  }{
      \left(\g-1\right)\C{u_x}{}
    + \frac{\left(\alpha+\frac{1}{3}\right)}{\Re}\ii\km\C{\nu}{}
  }{
  }
& \entry{\my\my  }
  \subcoeff{
      \bm{\frac{1}{\vp}} % M
    - \frac{\km^2+\kn^2}{\Re}\C{\nu}{}
  }{
      \left(\g-1\right)\C{u_y}{}
  }{
      \frac{\alpha+\frac{4}{3}}{\Re}\C{\nu}{}
  }
& \entry{\my\mz  }
  \subcoeff{
  }{
      \left(\g-1\right)\C{u_z}{}
    + \frac{\left(\alpha+\frac{1}{3}\right)}{\Re}\ii\kn\C{\nu}{}
  }{
  }
& \entry{\my{}e  }
  \subcoeff{
  }{
      \frac{1-\g}{\Ma^2}
  }{
  }
% Spanwise momentum row
\\\entry{\mz\rho}
  \subcoeff{
      \frac{1-\g}{2}\ii\kn\C{\mz}{\nabla\rho}
    + \frac{\km^2+\left(\alpha+\frac{4}{3}\right)\kn^2}{\Re}\C{\nu{}u_z}{}
    - \frac{\alpha+\frac{1}{3}}{\Re}\ii\left(\km+\kn\right)\C{\nu{}u_x}{}
  }{
    - \frac{\alpha+\frac{1}{3}}{\Re}\ii\kn\C{\nu{}u_y}{}
  }{
    - \frac{1}{\Re}\C{\nu{}u_z}{}
  }
& \entry{\mz\mx }
  \subcoeff{
      \left(1-\g\right)\ii\kn\C{u_x}{}
    + \frac{\left(\alpha+\frac{1}{3}\right)}{\Re}\ii\left(\km+\kn\right)\C{\nu}{}
  }{
  }{
  }
& \entry{\mz\my }
  \subcoeff{
      \left(1-\g\right)\ii\kn\C{u_y}{}
  }{
      \frac{\left(\alpha+\frac{1}{3}\right)}{\Re}\ii\kn\C{\nu}{}
  }{
  }
& \entry{\mz\mz }
  \subcoeff{
      \bm{\frac{1}{\vp}} % M
    + \left(1-\g\right)\ii\kn\C{u_z}{}
    - \frac{\km^2+\left(\alpha+\frac{4}{3}\right)\kn^2}{\Re}\C{\nu}{}
  }{
  }{
      \frac{1}{\Re}\C{\nu}{}
  }
& \entry{\mz{}e }
  \subcoeff{
      \frac{1-\g}{\Ma^2}\ii\kn
  }{
  }{
  }
% Total energy row
\\\entry{e\rho  }
  \subcoeff{
    - \ii\left(\km\C{e_x}{\nabla\rho} + \kn\C{e_z}{\nabla\rho}\right)
    - \g\frac{\km^2+\kn^2}{\Re\Pr\left(\g-1\right)}\C{e}{\Delta\rho}
  }{
    - \C{e_y}{\nabla\rho}
  }{
    \frac{\g}{\Re\Pr\left(\g-1\right)}\C{e}{\Delta\rho}
  }
& \entry{e\mx   }
  \subcoeff{
    - \ii\km\C{e}{\nabla\cdot{}m}
    + \frac{\g\Ma^2}{\Re\Pr}\left(\km^2+\kn^2\right)\C{\nu{}u_x}{}
  }{
  }{
    - \frac{\g\Ma^2}{\Re\Pr}\C{\nu{}u_x}{}
  }
& \entry{e\my   }
  \subcoeff{
      \frac{\g\Ma^2}{\Re\Pr}\left(\km^2+\kn^2\right)\C{\nu{}u_y}{}
  }{
    - \C{e}{\nabla\cdot{}m}
  }{
    - \frac{\g\Ma^2}{\Re\Pr}\C{\nu{}u_y}{}
  }
& \entry{e\mz   }
  \subcoeff{
    - \ii\kn\C{e}{\nabla\cdot{}m}
    + \frac{\g\Ma^2}{\Re\Pr}\left(\km^2+\kn^2\right)\C{\nu{}u_z}{}
  }{
  }{
    - \frac{\g\Ma^2}{\Re\Pr}\C{\nu{}u_z}{}
  }
& \entry{ee     }
  \subcoeff{
      \bm{\frac{1}{\vp}} % M
    - \g\ii\left(\km\C{u_x}{} + \kn\C{u_z}{}\right)
    - \frac{\g}{\Re\Pr}\left(\km^2+\kn^2\right)\C{\nu}{}
  }{
    - \g\C{u_y}{}
  }{
      \frac{\g}{\Re\Pr}\C{\nu}{}
  }
\end{bmatrix}
\renewcommand{\arraystretch}{1.0}
\begin{bmatrix}
  \hat{\rho}_{\left(0,\,m,\,n\right)} \\
  \vdots \\
  \hat{\rho}_{\left(N_y-1,\,m,\,n\right)} \\
\\%
\\%
  \hat{\mx}_{\left(0,\,m,\,n\right)} \\
  \vdots \\
  \hat{\mx}_{\left(N_y-1,\,m,\,n\right)} \\
\\%
\\%
  \hat{\my}_{\left(0,\,m,\,n\right)} \\
  \vdots \\
  \hat{\my}_{\left(N_y-1,\,m,\,n\right)} \\
\\%
\\%
  \hat{\mz}_{\left(0,\,m,\,n\right)} \\
  \vdots \\
  \hat{\mz}_{\left(N_y-1,\,m,\,n\right)} \\
\\%
\\%
  \hat{e}_{\left(0,\,m,\,n\right)} \\
  \vdots \\
  \hat{e}_{\left(N_y-1,\,m,\,n\right)} \\
%
\end{bmatrix}
\end{align*}
\end{minipage}}}  % END SCALE-TO-FIT!
\vspace{2em}
\\
\begin{minipage}[c]{\textwidth}  % SCALE-TO-FIT
The complete discrete operator $M+\varphi{}L$ used for implicit time advance is
depicted.  Notice the leftmost scalar factor $\bm{\vp}$!  The $3 N_y \times N_y$
blocked vectors written using curly braces are to be dotted against the blocked
vector $
  \trans{\begin{bmatrix} \M & \D{1} & \D{2} \end{bmatrix}}
$.
Each of $M$, $\D{1}$, and $\D{2}$ is a $N_y \times N_y$ banded matrix.
Reference quantities like $C^\nu$ are $N_y \times N_y$ diagonal matrices.  The
wavenumber-dependent operator takes wall-normal B-spline coefficients to
B-spline collocation point values.
\end{minipage}
 \caption[The discrete operator $M+\varphi{}L$ used for implicit time advance]{
  The complete discrete operator $M+\varphi{}L$ used for implicit time advance.
 }
\label{fig:discreteimplicitop}
\end{sidewaysfigure}

\subsection{Boundary conditions}

\subsubsection{Isothermal, no slip boundary condition}

An isothermal wall is characterized by a fixed temperature and zero velocity.
One thermodynamic quantity must be allowed to vary for this boundary condition
to be well-posed.  Allowing $\rho$ to vary is simplest given our state choices.
Then~\eqref{eq:state_pressure} and~\eqref{eq:state_temperature} combined with
$m=0$ forces $e=\frac{T}{\gamma\left(\gamma-1\right)}$ for some fixed
temperature $T$.  These conditions may be built into linear operators for
implicit treatment using how B-spline basis support limits the number of
nonzero coefficients at the wall as discussed in
section~\ref{sec:formingoperators}.

TODO Can one have a ``thermally rough'' wall by enforcing isothermal conditions
on only the zero-zero modes and doing something else on other modes?

\subsubsection{Isothermal, transpiring wall boundary condition}

TODO

\subsubsection{Nonreflecting freestream boundary conditions}

TODO

\begin{enumerate}
\item Reference Giles 1998 and Guarini's thesis (section 4.3.2)
\item Work through Guarini's transformation of Giles' result for our particular state variables (we use density and total energy unlike Guarini's specific volume and pressure).
\item Get to Guarini's equation (4.90) post haste.
\item Note the Poinsot and Lele 1992 reference discussing viscous conditions
\item Comment on implementation considerations
\end{enumerate}

\subsection{Imposing a favorable streamwise pressure gradient}

TODO

\section{In support of Favre-averaged Navier--Stokes modeling}
\label{sec:supportFANS}

The Favre-averaged Navier--Stokes (FANS) equations are often used to estimate
the mean effects of turbulence.  The unclosed FANS equations require modeling
approximations to be solvable.  Statistics gathered from Suzerain's solution of
the Navier--Stokes equations may be used to inform the development and
application of FANS closures.  Extensive background may be found in
books by Chassaing et.~al.~\cite{Chassaing2010} or Smits and
Dussauge~\cite{SmitsDussauge2005}.

The material in this section borrows liberally (and often literally) from work
by Todd Oliver~\cite{OliverFANSModels2011}.  It departs from that particular
document in that it employs Suzerain's constitutive relationships, avoids
introducing customary assumptions about the relative importance of unclosed
terms, accounts for forcing, and nondimensionalizes the results.


\subsection{Reynolds- and Favre-averages}
\label{sec:averaging}

The Reynolds average is simply the usual mean of a random variable.  Consider a
generic flow variable $q$.  The value, $q(x, y, z, t)$, of this variable at a
particular point in space, $(x, y, z)$, and time, $t$, is a random variable.
Assuming that the probability density function for $q(x, y, z, t)$ is given by
$\pi_q(V; x, y, z, t)$, the Reynolds average is defined by
%
\begin{equation}
\label{eqn:reynoldsAvg}
\bar{q}(x, y, z, t) \equiv \int V \pi_q(V; x, y, z, t) \,\mathrm{d} V.
\end{equation}
%
The Favre average is defined as the density-weighted average.  Thus,
denoting the fluid density by $\rho(x,y,z, t)$, the Favre average of
$q(x,y,z, t)$ is
%
\begin{equation*}
\tilde{q}(x,y,z, t) \equiv \frac{ \overline{\rho q}(x,y,z, t) }{ \bar{\rho}(x,y,z, t) }.
\end{equation*}
%
For the remainder of this section to make sense mathematically, it is
assumed that both the Reynolds and Favre averages are well-defined for
any required flow variable, $q$.  That is, the integral on the
right-hand side of (\ref{eqn:reynoldsAvg}) exists whenever required,
and the Reynolds-averaged density, $\bar{\rho}$, is positive
everywhere.

In the following, the flow variables will be decomposed into mean and
fluctuating parts.  Specifically, the fluctuations about the
mean---denoted by $(\cdot)'$ and $(\cdot)''$ for the Reynolds and
Favre averages, respectively---are defined by the following
relationships:
%
\begin{align*}
q' &\equiv q - \bar{q}, \\
q'' &\equiv q - \tilde{q}.
\end{align*}
%
Using the linearity of the Reynolds average and the fact that
$\bar{q}$ and $\tilde{q}$ are deterministic, not random, variables, it
is straightforward to see that
%
\begin{gather*}
\overline{q'} = \overline{q - \bar{q}} = \bar{q} - \bar{q} =  0, \\
\widetilde{q''} = \widetilde{q - \tilde{q}} = \tilde{q} - \tilde{q} = 0.
\end{gather*}
%
Furthermore,
%
\begin{equation*}
\overline{\rho q''} = \bar{\rho} \widetilde{q''} = 0.
\end{equation*}
%
However, in general,
%
\begin{equation*}
\overline{q''} = \overline{q - \tilde{q}} = \bar{q} - \tilde{q} \neq 0.
\end{equation*}
%

Wherever necessary, realizations of random fields of flow quantities
are assumed to be differentiable in both time and space so that Reynolds
averaging and differentiation commute.  For example,
%
\begin{equation*}
\overline{ \nabla{}u } = \nabla\bar{u}.
\end{equation*}
%
This commutativity is used to develop the FANS equations.  In contrast, Favre
averaging and differentiation do not, in general, commute:
\begin{align}
  \rho \nabla q &= \rho \nabla q
\\
   \rho \widetilde{\nabla{}q} + \rho \left(\nabla{}q\right)''
&=
   \rho \nabla \tilde{q} + \rho \nabla{}q''
\\
     \bar{\rho} \widetilde{\nabla{}q}
&=
     \bar{\rho} \nabla{\tilde{q}}
   + \overline{\rho \nabla{}q''}
\\
&=
     \bar{\rho} \nabla{\tilde{q}}
   - \overline{q''\nabla\rho}
\end{align}
We have adopted the common convention that taking Favre fluctuations
$\left(\cdot\right)''$ has higher precedence than $\nabla\left(\cdot\right)$.
Rearranging to better examine the difference between $\widetilde{\nabla{}q}$
and $\nabla\tilde{q}$ in terms of mean quantities,
\begin{align}
  \label{eq:favremeancommute}
  \widetilde{\nabla{}q}
  -
  \nabla{\tilde{q}}
&=
  \widetilde{\nabla{}q''}
= - \frac{{\overline{q''\nabla\rho}}}{\bar{\rho}}
= \frac{\tilde{q}\nabla\bar{\rho}}{\bar{\rho}}
  - \frac{\overline{q\nabla\rho}}{\bar{\rho}}
.
\end{align}
This lack of commutativity not problematic as it is not required to derive the
FANS equations.  It does, however, slightly complicate the mean constitutive
relationships.  The fluctuating gradient and the gradient of the fluctuations
differ according to
\begin{align}
  \label{eq:favrefluctcommute}
  \left(\nabla{}q\right)'' - \nabla{}q'' &= - \widetilde{\nabla{}q''}
.
\end{align}
In some circumstances, the difference between quantities written using a
fluctuating gradient and the gradient of the fluctuations can vanish.
One useful example is
\begin{align}
  \label{eq:favrefluctexample}
\widetilde{f''\left(\nabla{}g\right)''}
&=
\overline{\rho{}f''\left(\nabla{}g\right)''}
=
\overline{\rho{}f''\left(\nabla{}g'' - \widetilde{\nabla{}g''}\right)}
=
\overline{\rho{}f''\nabla{}g''}
- \overline{\rho{}f''}\widetilde{\nabla{}g''}
=
\widetilde{f''\nabla{}g''}
.
\end{align}

\subsection{The dimensional Favre-averaged Navier--Stokes equations}

\subsubsection{Derivation}

Recall that equations~\eqref{eq:cons_mass}, \eqref{eq:cons_momentum},
and~\eqref{eq:cons_energy} may be written as
\begin{align}
    \frac{\partial}{\partial{}t}\rho
&=
  - \nabla\cdot\rho{}u
\\
    \frac{\partial{}}{\partial{}t}\rho{}u
&=
  - \nabla\cdot(u\otimes{}\rho{}u)
  - \nabla{}p + \nabla\cdot{}\tau + f
\\
    \frac{\partial}{\partial{}t} \rho{}E
&=
  - \nabla\cdot{}\rho{}Hu
  + \nabla\cdot{}\tau{}u
  - \nabla\cdot{}q_{s}
  + f\cdot{}u
  + q_b
\end{align}
where we have employed total enthalpy $H$ to reduce the number of terms in the
energy equation.

A lengthy algebraic procedure (detailed in section~2
of~\cite{OliverFANSModels2011}) produces exact equations governing the
evolution of mean conserved quantities $\bar{\rho}$, $\overline{\rho{}u}=
\bar{\rho}\tilde{u}$, and $\overline{\rho{}E} = \bar{\rho}\tilde{E}$:
\begin{subequations}\label{eq:unclosedfansequations}
\begin{align}
    \frac{\partial}{\partial{}t}\bar{\rho}
 =
 &- \nabla\cdot\bar{\rho}\tilde{u}
\\
    \frac{\partial{}}{\partial{}t}\bar{\rho}\tilde{u}
 =
 &- \nabla\cdot(\tilde{u}\otimes\bar{\rho}\tilde{u})
  - \nabla{}\bar{p}
  + \nabla\cdot\left(
        \bar{\tau}
      - \bar{\rho}\widetilde{u''\otimes{}u''}
    \right)
  + \bar{f}
\\
  \frac{\partial}{\partial{}t} \bar{\rho}\tilde{E}
 =
 &- \nabla\cdot{}\bar{\rho}\tilde{H}\tilde{u}
  + \nabla\cdot\left(
        \left(
            \bar{\tau}
          - \bar{\rho} \widetilde{u''\otimes{}u''}
        \right) \tilde{u}
      - \frac{1}{2}\bar{\rho}\widetilde{{u''}^{2}u''}
      + \overline{\tau{}u''}
    \right)
\\
 &- \nabla\cdot\left(
        \bar{q}_s
      + \bar{\rho} \widetilde{h''u''}
    \right)
  + \bar{f}\cdot\tilde{u}
  + \overline{f\cdot{}u''}
  + \bar{q}_{b}
\end{align}
\end{subequations}
Several correlations impact the evolution of mean quantities: the Reynolds
stress $-\bar{\rho}\widetilde{u''\otimes{}u''}$, the Reynolds heat flux
$\bar{\rho} \widetilde{h''u''}$, turbulent transport
$-\frac{1}{2}\bar{\rho}\widetilde{{u''}^{2}u''}$, turbulent work
$\overline{\tau{}u''}$, and the forcing-velocity correlation
$\overline{f\cdot{}u''}$.  The Reynolds stress and heat flux augment the
viscous stress and heat flux, respectively.  The turbulent transport and work
terms represent transport of the turbulent kinetic energy density $k$, defined
below, and viscous stress work due to turbulent velocity fluctuations,
respectively.

We now average the perfect gas relations from section~\ref{sec:constitutive}.
The Reynolds average of~\eqref{eq:perfectgaseos} gives
\begin{align}
  \bar{p} &= R\overline{\rho{}T} = \bar{\rho}R\tilde{T}
\end{align}
while the Favre average of~\eqref{eq:perfectgasenthalpy} gives both
\begin{align}
 \tilde{H} &= \tilde{E} + R \tilde{T}
&
 \tilde{h} &= \frac{\gamma{}R\tilde{T}}{\gamma-1}.
\end{align}
The turbulent kinetic energy density
\begin{align}
  k &= \frac{1}{2}\widetilde{{u''}^2}
 \end{align}
arises from averaging the total energy given by
\eqref{eq:perfectgastotalenergy}:
\begin{align}
  \rho{} E
&=
  \frac{R}{\gamma-1} \rho{}T + \frac{1}{2}\rho{} u^{2}
\\
&=
  \frac{R}{\gamma-1} \rho{}\left( \tilde{T} + T'' \right)
+ \frac{1}{2}\rho{} \left( \tilde{u} + u'' \right)^2
\\
  \overline{\rho{}E}
&=
  \frac{R}{\gamma-1} \bar{\rho} \tilde{T}
+ \frac{1}{2}\bar{\rho} \tilde{u}^2
+ \frac{1}{2}\overline{\rho{}{u''}^2}
\\
  \tilde{E}
&=
  \frac{R}{\gamma-1} \tilde{T}
+ \frac{1}{2} \tilde{u}^2
+ k
\end{align}

An exact equation may be derived for the evolution of $k$ (details in section~5
of~\cite{OliverFANSModels2011})
\begin{align}
\label{eq:fanstke1}
    \frac{\partial{}}{\partial{}t}\bar{\rho}k
 =
 &- \nabla\cdot\bar{\rho}k\tilde{u}
  - \bar{\rho} \widetilde{u''\otimes{}u''} : \nabla\tilde{u}
  - \bar{\rho} \epsilon
  + \nabla\cdot\left(
        -\frac{1}{2}\bar{\rho}\widetilde{{u''}^{2}u''}
      + \overline{\tau{}u''}
    \right)
\\
 &- \overline{u''}\cdot\nabla\bar{p}
  - \nabla\cdot\overline{p' u''}
  + \overline{p' \nabla\cdot{}u''}
  + \overline{f\cdot{}u''}
\end{align}
where $A:B$ denotes $\trace \left(\trans{A} B\right)$. The dissipation rate
density $\epsilon$, which governs the conversion rate from $k$ to mean internal
energy, is defined by
\begin{align}
  \bar{\rho} \epsilon &= \overline{\tau : \nabla{}u''}
.
\end{align}
As page~216 of Lele~\cite{Lele1994Compressibility} suggests, expanding $h$,
averaging, removing the mean state from both sides, and applying perfect gas
assumptions demonstrates the exact relationship
\begin{align}
  \overline{u''}
&=
  \frac{\widetilde{T''u''}}{\tilde{T}} - \frac{\overline{p'u''}}{\bar{p}}
.
\end{align}
Substituting $h''$ everywhere for $T''$, noting $\bar{p}/\tilde{h} =
\frac{\gamma-1}{\gamma}\bar{\rho}$, and differentiating one obtains
\begin{align}
  \overline{p'u''}
&=
  \frac{\gamma-1}{\gamma} \bar{\rho} \widetilde{h''u''}
- \bar{p} \overline{u''}
\\
  \nabla\cdot \overline{p'u''}
&=
  \frac{\gamma-1}{\gamma} \nabla\cdot \bar{\rho} \widetilde{h''u''}
- \bar{p}\nabla\cdot\overline{u''}
- \overline{u''}\cdot\nabla{}\bar{p}
.
\end{align}
Rearranging the above result to mimic terms within~\eqref{eq:fanstke1}
\begin{align}
  - \overline{u''}\cdot\nabla\bar{p}
  - \nabla\cdot\overline{p'u''}
&=
  \bar{p}\nabla\cdot\overline{u''}
- \frac{\gamma-1}{\gamma} \nabla\cdot \bar{\rho} \widetilde{h''u''}
\end{align}
allows us to trade an occurrence of $\overline{p'u''}$ for the Reynolds heat
flux in the exact $k$ equation:
\begin{align}
\label{eq:fanstke}
    \frac{\partial{}}{\partial{}t}\bar{\rho}k
 =
 &- \nabla\cdot\bar{\rho}k\tilde{u}
  - \bar{\rho} \widetilde{u''\otimes{}u''} : \nabla\tilde{u}
  - \bar{\rho} \epsilon
  + \nabla\cdot\left(
        -\frac{1}{2}\bar{\rho}\widetilde{{u''}^{2}u''}
      + \overline{\tau{}u''}
    \right)
\\
 &+ \bar{p}\nabla\cdot\overline{u''}
  - \frac{\gamma-1}{\gamma} \nabla\cdot\bar{\rho} \widetilde{h''u''}
  + \overline{p' \nabla\cdot{}u''}
  + \overline{f\cdot{}u''}
\end{align}
The trade reduces by one the number of correlations appearing in the $k$
equation which do not appear in the mean continuity, momentum, or energy
equations.  It also, as Lele suggests, encourages thermodynamic consistency
when working with pressure correlation information.

Returning to the constitutive relations, combining~\eqref{eq:tauSmub}
and~\eqref{eq:secondviscosityclaw} we obtain
\begin{align}
  \tau
&= 2 \mu{} S + \alpha \mu \left( \nabla\cdot{}u \right) I.
\end{align}
Using the kinematic viscosity $\nu = \mu / \rho$ and averaging we find
\begin{align}
   \tilde{S}
&=
     \frac{1}{2}\left(
       \widetilde{\nabla{}u} + \trans{\widetilde{\nabla{}u}}
     \right)
   - \frac{1}{3}\left(\widetilde{\nabla\cdot{}u}\right) I
\\
  \bar{\tau}
&=
    2 \bar{\mu}\tilde{S}
  + 2 \bar{\rho} \widetilde{\nu''S''}
  + \alpha \bar{\mu} \widetilde{\nabla\cdot{}u} I
  + \alpha \bar{\rho} \widetilde{\nu''\left(\nabla\cdot{}u\right)''} I
.
\end{align}
By~\eqref{eq:favrefluctexample},
$\widetilde{\nu''\left(\nabla\cdot{}u\right)''}$ may also be written
$\widetilde{\nu''\nabla\cdot{}u''}$ while $\widetilde{\nu''S''}$ is equivalent
to a version using the deviatoric part of the strain rate of the fluctuating
velocity field.  Many FANS closure approximations neglect correlations between
the kinematic viscosity and velocity derivatives.  Many assume $\alpha=0$.
Accepting those approximations would eliminate the second through fourth terms
in $\bar{\tau}$.  Making the ubiquitous closure approximations
$\widetilde{\nabla{}u} + \trans{\widetilde{\nabla{}u}} \approx \nabla\tilde{u}
+ \trans{\nabla\tilde{u}}$ and
$\widetilde{\nabla{}\cdot{}u}\approx\nabla\cdot\tilde{u}$ are equivalent to
neglecting $\widetilde{\nabla{}u''} + \trans{\widetilde{\nabla{}u''}}$ and
$\widetilde{\nabla{}\cdot{}u''}$ per~\eqref{eq:favremeancommute}.

To find $\bar{q}_s$ we combine~\eqref{eq:fourierlaw} and our assumption of a
constant Prandtl number
\begin{align}
  q_{s} &= - \kappa \nabla{} T
     = - \frac{\kappa}{C_p} \nabla{}h
     = - \frac{\mu}{\Prandtl} \nabla{}h
\end{align}
and again employ $\nu$ when averaging to obtain
\begin{align}
  \bar{q}_s
&= - \frac{1}{\Prandtl}\left(
                \bar{\mu}\widetilde{\nabla{}h}
              + \bar{\rho} \widetilde{\nu''\left(\nabla{}h\right)''}
            \right)
.
\end{align}
Again, by~\eqref{eq:favrefluctexample},
$\widetilde{\nu''\left(\nabla{}h\right)''}$ may also be written
$\widetilde{\nu''\nabla{}h''}$.  Again, making the ubiquitous closure
assumption $\widetilde{\nabla{}h}\approx\nabla\tilde{h}$ is equivalent to
neglecting $\widetilde{\nabla{}h''}$ per~\eqref{eq:favremeancommute}.
Straightforward averaging applied to~\eqref{eq:powerlawviscosity} produces
\begin{align}
   \bar{\rho}\tilde{\nu}
 = \bar{\mu}
&= \mu_0 \overline{\left(\frac{T}{T_0}\right)^\beta}
\end{align}
which is not computable given only Favre-averaged state.  One commonly accepted
simplification is taking $\overline{\mu\left(T\right)} \approx
\mu\left(\tilde{T}\right)$.

\subsubsection{Summary}

The Favre-averaged equations of interest are:
\begin{subequations}
\begin{align}
    \frac{\partial}{\partial{}t}\bar{\rho}
=
 &- \nabla\cdot\bar{\rho}\tilde{u}
\\
    \frac{\partial{}}{\partial{}t}\bar{\rho}\tilde{u}
 =
 &- \nabla\cdot(\tilde{u}\otimes\bar{\rho}\tilde{u})
  - \nabla{}\bar{p}
  + \nabla\cdot\left(
        \bar{\tau}
      - \bar{\rho} \widetilde{u''\otimes{}u''}
    \right)
  + \bar{f}
\\
    \frac{\partial}{\partial{}t} \bar{\rho}\tilde{E}
 =
 &- \nabla\cdot{}\bar{\rho}\tilde{H}\tilde{u}
  + \nabla\cdot\left(
        \left(
            \bar{\tau}
          - \bar{\rho} \widetilde{u''\otimes{}u''}
        \right) \tilde{u}
      - \frac{1}{2}\bar{\rho}\widetilde{{u''}^{2}u''}
      + \overline{\tau{}u''}
    \right)
\\
 &- \nabla\cdot\left(
        \bar{q}_s
      + \bar{\rho} \widetilde{h''u''}
    \right)
  + \bar{f}\cdot\tilde{u}
  + \overline{f\cdot{}u''}
  + \bar{q}_b
\\
    \frac{\partial{}}{\partial{}t}\bar{\rho}k
=
 &- \nabla\cdot\bar{\rho}k\tilde{u}
  - \bar{\rho} \widetilde{u''\otimes{}u''} : \nabla\tilde{u}
  - \bar{\rho} \epsilon
  + \nabla\cdot\left(
        -\frac{1}{2}\bar{\rho} \widetilde{{u''}^{2}u''}
      + \overline{\tau{}u''}
    \right)
\\
 &+ \bar{p}\nabla\cdot\overline{u''}
  - \frac{\gamma-1}{\gamma} \nabla\cdot\bar{\rho} \widetilde{h''u''}
  + \overline{p' \nabla\cdot{}u''}
  + \overline{f\cdot{}u''}
\end{align}
The equations are augmented by the following relationships:
\begin{align}
  \bar{p} &= \bar{\rho}R\tilde{T}
&
   \bar{\rho}\tilde{\nu} =
   \bar{\mu}
&= \mu_0 \overline{\left(\frac{T}{T_0}\right)^\beta}
&
  k &= \frac{1}{2}\widetilde{{u''}^2}
&
  \bar{\rho} \epsilon &= \overline{\tau : \nabla{}u''}
\end{align}
\begin{align}
  \tilde{E}
&=
  \frac{R}{\gamma-1} \tilde{T}
+ \frac{1}{2} \tilde{u}^2
+ k
&
  \tilde{H}
&=
  \tilde{E}
+ R \tilde{T}
&
  \tilde{h} &= \frac{\gamma{}R\tilde{T}}{\gamma-1}
&
  \bar{q}_s
&= - \frac{1}{\Prandtl}\left(
                \bar{\mu}\widetilde{\nabla{}h}
              + \bar{\rho} \widetilde{\nu''\left(\nabla{}h\right)''}
            \right)
\end{align}
\begin{align}
   \tilde{S}
&=
     \frac{1}{2}\left(
       \widetilde{\nabla{}u} + \trans{\widetilde{\nabla{}u}}
     \right)
   - \frac{1}{3}\left(\widetilde{\nabla\cdot{}u}\right) I
&
   \bar{\tau}
&=  2 \bar{\mu}\tilde{S}
  + 2 \bar{\rho} \widetilde{\nu''S''}
  + \alpha \bar{\mu} \widetilde{\nabla\cdot{}u} I
  + \alpha \bar{\rho} \widetilde{\nu''\left(\nabla\cdot{}u\right)''} I
\end{align}
\end{subequations}
One may exactly compute the mean state evolution given the following
information:
\begin{samepage}
\begin{align}
&\bar{\rho}
&
&\tilde{u}
&
&\tilde{E}
&
&\bar{\mu}
&
&\bar{f}
&
&\bar{q}_b
&
&k
&
&\epsilon
&
&\overline{u''}
&
&\symmetricpart{\widetilde{\nabla{}u}}
\end{align}
\begin{align}
&\overline{f\cdot{}u''}
&
&\overline{\tau{}u''}
&
&\overline{p'\nabla\cdot{}u''}
&
&-\widetilde{u''\otimes{}u''}
&
&-\frac{1}{2}\widetilde{{u''}^{2}u''}
&
&\widetilde{h''u''}
&
&\widetilde{\nu''S''}
&
&\widetilde{\nu''\left(\nabla\cdot{}u\right)''}
&
&\widetilde{\nu''\left(\nabla{}h\right)''}
\end{align}
\end{samepage}
Other ways to minimally capture the mean thermodynamic state, e.g. $\bar{\rho}$
and $\tilde{T}$, could have been chosen.  The information above are natural
choices following section~\ref{state_variable_selection}.  Favre-fluctuating
correlation densities (e.g.  $\widetilde{h''u''}$ are adopted for notational
brevity instead of their informationally equivalent Reynolds-averaged
correlations (e.g.  $\overline{\rho{}h''u''}$).

\subsection{The nondimensional Favre-averaged Navier--Stokes equations}
\label{sec:nondimfans}

The dimensional FANS equations from the last section need to be
nondimensionalized.   The reference quantity selections made in
section~\ref{sec:nondimrefq} are used and are augmented by
\begin{align}
  k_0 &= u_{0}^2
&
  \epsilon_0 &= \frac{u_{0}^2}{t_0}
\end{align}
Superscript star notation is suppressed as all terms
are dimensionless.  The results are:
\begin{subequations}
\begin{align}
    \frac{\partial}{\partial{}t}\bar{\rho}
=
 &- \nabla\cdot\bar{\rho}\tilde{u}
\\
    \frac{\partial{}}{\partial{}t}\bar{\rho}\tilde{u}
=
 &- \nabla\cdot(\tilde{u}\otimes\bar{\rho}\tilde{u})
  - \frac{1}{\Mach^2}\nabla{}\bar{p}
  + \nabla\cdot\left(
        \frac{\bar{\tau}}{\Reynolds}
      - \bar{\rho} \widetilde{u''\otimes{}u''}
    \right)
  + \bar{f}
\\
  \frac{\partial}{\partial{}t} \bar{\rho}\tilde{E}
=
 &- \nabla\cdot\bar{\rho}\tilde{H}\tilde{u}
  + \Mach^{2} \nabla\cdot\left(
        \left(
            \frac{\bar{\tau}}{\Reynolds}
          - \bar{\rho} \widetilde{u''\otimes{}u''}
        \right) \tilde{u}
      - \frac{1}{2}\bar{\rho}\widetilde{{u''}^{2}u''}
      + \frac{\overline{\tau{}u''}}{\Reynolds}
    \right)
\\
 &+ \frac{1}{\gamma-1} \nabla\cdot\left(
      \frac{
         \bar{\mu} \widetilde{\nabla{}T}
       + \bar{\rho} \widetilde{\nu'' \left(\nabla{}T\right)''}
      }{\Reynolds\Prandtl}
      - \bar{\rho} \widetilde{T''u''}
    \right)
  + \Mach^{2} \left(
        \bar{f}\cdot\tilde{u}
      + \overline{f\cdot{}u''}
    \right)
  + \bar{q}_b
\\
    \frac{\partial{}}{\partial{}t}\bar{\rho}k
=
 &- \nabla\cdot\bar{\rho}k\tilde{u}
  - \bar{\rho} \widetilde{u''\otimes{}u''} : \nabla\tilde{u}
  - \frac{\bar{\rho} \epsilon}{\Reynolds}
  + \nabla\cdot\left(
        -\frac{1}{2}\bar{\rho} \widetilde{{u''}^{2}u''}
      + \frac{\overline{\tau{}u''}}{\Reynolds}
    \right)
\\
 &+ \frac{1}{\Mach^2} \left(
        \bar{p}\nabla\cdot\overline{u''}
      + \overline{p' \nabla\cdot{}u''}
      - \frac{1}{\gamma} \nabla\cdot\bar{\rho} \widetilde{T''u''}
    \right)
  + \overline{f\cdot{}u''}
\end{align}
The equations are augmented by the following nondimensional relationships:
\begin{align}
  \bar{p} &= \frac{\bar{\rho} \tilde{T}}{\gamma}
&
   \bar{\rho}\tilde{\nu} =
   \bar{\mu}
&= \overline{T^\beta}
&
  k &= \frac{1}{2}\widetilde{{u''}^2}
&
  \bar{\rho} \epsilon &= \overline{\tau : \nabla{}u''}
\end{align}
\begin{align}
  \tilde{E}
&=
  \frac{\tilde{T}}{\gamma\left(\gamma-1\right)}
  + \Mach^2 \left( \frac{1}{2}\tilde{u}^2 + k
  \right)
&
  \tilde{H}
&=
  \tilde{E} + \frac{\tilde{T}}{\gamma}
&
  \tilde{h} &= \frac{\tilde{T}}{\gamma-1}
\end{align}
\begin{align}
   \tilde{S}
&=
     \frac{1}{2}\left(
       \widetilde{\nabla{}u} + \trans{\widetilde{\nabla{}u}}
     \right)
   - \frac{1}{3}\left(\widetilde{\nabla\cdot{}u}\right) I
&
   \bar{\tau}
&=  2 \bar{\mu}\tilde{S}
  + 2 \bar{\rho} \widetilde{\nu''S''}
  + \alpha \bar{\mu} \widetilde{\nabla\cdot{}u} I
  + \alpha \bar{\rho} \widetilde{\nu''\left(\nabla\cdot{}u\right)''} I
\end{align}
\end{subequations}
where $\Reynolds$, $\Mach$, and $\Prandtl$ are defined as in
section~\ref{sec:nondimrefq}.  One may exactly compute the nondimensional mean
state evolution given the following statistical quantities:
\begin{samepage}
\begin{align}
&\bar{\rho}
&
&\tilde{u}
&
&\tilde{E}
&
&\bar{\mu}
&
&\bar{f}
&
&\bar{q}_b
&
&k
&
&\epsilon
&
&\overline{u''}
&
&\symmetricpart{\widetilde{\nabla{}u}}
\end{align}
\begin{align}
&\overline{f\cdot{}u''}
&
&\overline{\tau{}u''}
&
&\overline{p'\nabla\cdot{}u''}
&
&-\widetilde{u''\otimes{}u''}
&
&-\frac{1}{2}\widetilde{{u''}^{2}u''}
&
&\widetilde{T''u''}
&
&\widetilde{\nu''S''}
&
&\widetilde{\nu''\left(\nabla\cdot{}u\right)''}
&
&\widetilde{\nu''\left(\nabla{}T\right)''}
\end{align}
\end{samepage}

Notice that the heat flux $\bar{q}_s$ has been merged into the mean energy
equation to better mimic \eqref{eq:nondim_energy}.  Enthalpy-based correlations
have been replaced by temperature-based correlations.  Notice also that the
choice of $p_0$ implies nondimensional $p$ includes a factor of $\gamma$
relative to the dimensional quantity.  Where possible, nondimensional
coefficients have been pulled out of the constitutive relationships and pushed
into the equations (for example, the factor $1/\Reynolds$ arising from the
dimensional definition of $\bar{\rho}\epsilon$).

\subsection{Sampling logistics}

Statistical quantities are obtained by sampling from a well-resolved,
stationary simulation.  Mean quantities may be computed on-the-fly.
Fluctuating quantity samples, because they must be taken relative to an unknown
true mean, are computed by combining mean quantity samples following the rules
in section~\ref{sec:averaging}.

Sampling the following mean quantities is sufficient to compute
the statistical quantities listed in section~\ref{sec:nondimfans}:
\begin{samepage}
\begin{align}
&\bar{\rho}
&
&\overline{\rho{}u}
&
&\overline{\rho{}E}
&
&\bar{\mu}
&
&\bar{f}
&
&\bar{q}_b
&
&\bar{u}
&
&\symmetricpart{\overline{\rho\nabla{}u}}
&
&\overline{\rho\nabla{}T}
&
&\overline{\tau:\nabla{}u}
&
&\overline{f\cdot{}u}
&
&\bar{\tau}
\end{align}
\begin{align}
&\overline{\tau{}u}
&
&\overline{p\nabla\cdot{}u}
&
&\overline{\rho{}u\otimes{}u}
&
&\overline{\rho{}u\otimes{}u\otimes{}u}
&
&\overline{\rho{}Tu}
&
&\overline{\mu{}S}
&
&\overline{\mu\nabla\cdot{}u}
&
&\overline{\mu\nabla{}T}
\end{align}
\end{samepage}
After averaging across the homogeneous streamwise $x$ and spanwise $z$
directions, each sample (ignoring tensor order) is a one-dimensional,
instantaneous profile varying only along the wall-normal B-spline direction.
The amount of data gathered may be reduced by exploiting symmetries in
$\bar{\tau}$, $\overline{\rho{}u\otimes{}u}$,
$\overline{\rho{}u\otimes{}u\otimes{}u}$, and $\overline{\mu{}S}$.

The instantaneous samples are combined according to the following ordered
sequence of computations to obtain the desired quantities:
{ \allowdisplaybreaks[1]
\begin{align}
  \tilde{u} &= \bar{\rho}^{-1} \overline{\rho{}u}
\\
  \tilde{E} &= \bar{\rho}^{-1} {\overline{\rho{}E}}
\\
  \widetilde{u\otimes{}u} &= \bar{\rho}^{-1} \overline{\rho{}u\otimes{}u}
\\
  \widetilde{u''\otimes{}u''} &=
  \widetilde{u\otimes{}u} - \tilde{u}\otimes\tilde{u}
\\
  k &= \frac{1}{2} \trace \widetilde{u''\otimes{}u''}
\\
  \tilde{T} &= \gamma\left(\gamma-1\right)\left(
      \tilde{E} - \Mach^2\left(\frac{1}{2}\tilde{u}^2 + k\right)
  \right)
\\
  \tilde{H} &= \tilde{E} + \frac{\tilde{T}}{\gamma}
\\
  \bar{p} &= \frac{\bar{\rho}\tilde{T}}{\gamma}
\\
  \overline{\tau:\nabla{}u''} &=
  \overline{\tau:\nabla{}u} - \bar{\tau}:\nabla\tilde{u}
\\
  \epsilon &= \bar{\rho}^{-1} \overline{\tau:\nabla{}u''}
\\
  \overline{u''} &= \bar{u} - \tilde{u}
\\
  \overline{f\cdot{}u''} &= \overline{f\cdot{}u} - \bar{f}\cdot{}\tilde{u}
\\
  \overline{\tau{}u''} &= \overline{\tau{}u} - \bar{\tau}\tilde{u}
\\
  \overline{p'\nabla\cdot{}u''}
  &= \overline{p\nabla\cdot{}u}
   - \bar{p}\nabla\cdot\bar{u}
\\
  \widetilde{u\otimes{}u\otimes{}u}
  &= \bar{\rho}^{-1} \overline{\rho{}u\otimes{}u\otimes{}u}
\end{align}
}

Expressions for computing $\widetilde{u''\otimes{}u''\otimes{}u''}$ and
$-\frac{1}{2}\widetilde{{u''}^{2}u''}$ are derived in stages using index
notation and the summation convention.  Using the identities
\begin{align}
  \widetilde{u_{i}u_{j}''}
&=
  \widetilde{u_{i}u_{j}} - \tilde{u}_{i}\tilde{u}_{j}
\\
  \widetilde{u_{i}u_{j}u_{k}''}
&=
  \widetilde{u_{i}u_{j}u_{k}} - \widetilde{u_{i}u_{j}}\tilde{u}_{k}
\shortintertext{
and ignoring any symmetry-related simplifications, we obtain
}
  \widetilde{u_{i}''u_{j}''u_{k}''}
  &= \bar{\rho}^{-1} \overline{\rho{}\left(u_{i}-\tilde{u}_{i}\right)
                                     \left(u_{j}-\tilde{u}_{j}\right)
                                     u_{k}''}
\\
  &= \widetilde{u_{i}u_{j}u_{k}''}
   - \tilde{u}_i \widetilde{u_{j}u_{k}''}
   - \tilde{u}_j \widetilde{u_{i}u_{k}''}
%%\\
%%  &= \widetilde{u_{i}u_{j}u_{k}}
%%   - \widetilde{u_{i}u_{j}}\tilde{u}_{k}
%%   - \tilde{u}_{i} \widetilde{u_{j} u_{k}}
%%   + \tilde{u}_{i} \tilde{u}_{j}\tilde{u}_{k}
%%   - \tilde{u}_{j} \widetilde{u_{i}u_{k}}
%%   + \tilde{u}_{j} \tilde{u}_{i}\tilde{u}_{k}
\\
  &=   \widetilde{u_{i}u_{j}u_{k}}
   -   \widetilde{u_{i}u_{j}}\tilde{u}_{k}
   -   \tilde{u}_{i} \widetilde{u_{j} u_{k}}
   -   \tilde{u}_{j} \widetilde{u_{i}u_{k}}
   + 2 \tilde{u}_{i} \tilde{u}_{j}\tilde{u}_{k}
.
\shortintertext{
Contracting the first two indices and relabelling the third index,
}
  \widetilde{u_{i}''u_{i}''u_{j}''}
  &= \widetilde{u_{i}u_{i}u_{j}}
   - \widetilde{u_{i}u_{i}}\tilde{u}_{j}
   - 2 \tilde{u}_{i} \widetilde{u_{i} u_{j}}
   + 2 \tilde{u}_{i} \tilde{u}_{i}\tilde{u}_{j}
   .
\shortintertext{
Reverting to direct notation and employing the symmetry of
$\widetilde{u\otimes{}u}$, we arrive at
}
  \widetilde{{u''}^{2}u''}
&=
      \widetilde{u^{2}u}
  -   \widetilde{u^{2}}\tilde{u}
  - 2 \widetilde{u\otimes{}u}\tilde{u}
  + 2 \tilde{u}^2 \tilde{u}
\end{align}
where $\widetilde{u^{2}u}$ and $\widetilde{u^2}$ may be computed by contracting
$\widetilde{u\otimes{}u\otimes{}u}$ and $\widetilde{u\otimes{}u}$,
respectively.

Continuing the ordered sequence of computations:
\begin{align}
  \widetilde{Tu} &= \bar{\rho}^{-1} \overline{\rho{}Tu}
\\
  \widetilde{T''u''} &= \widetilde{Tu} - \tilde{T}\tilde{u}
\\
  \tilde{\nu} &= \bar{\rho}^{-1} \overline{\mu}
\\
  \symmetricpart{\widetilde{\nabla{}u}}
  &= \bar{\rho}^{-1} \symmetricpart{\overline{\rho\nabla{}u}}
\\
  \tilde{S} &= \symmetricpart{\widetilde{\nabla{}u}}
   - \frac{1}{3} \trace\symmetricpart{\widetilde{\nabla{}u}} I
\\
  \widetilde{\nu''S''}
  &= \bar{\rho}^{-1} \overline{\mu{}S} - \tilde{\nu}\tilde{S}
\\
  \widetilde{\nu''\left(\nabla\cdot{}u\right)''}
  &= \bar{\rho}^{-1} \overline{\mu\nabla\cdot{}u}
   - \tilde{\nu}\trace\symmetricpart{\widetilde{\nabla{}u}}
\\
  \widetilde{\nu''\left(\nabla{}T\right)''}
  &= \bar{\rho}^{-1} \overline{\mu\nabla{}T}
   - \tilde{\nu} \bar{\rho}^{-1} \overline{\rho\nabla{}T}
\end{align}

\subsection{Quantifying statistical quantity convergence}
\label{sec:quantconvergence}

TODO


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%% Bibliography %%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\bibliographystyle{amsplain}
\bibliography{references}


%%%\appendix
%%%
%%%\section{Miscellaneous}
%%%
%%%\subsection{The Variable Density Equations}
%%%
%%%The limits of the compressible Navier--Stokes equations as the Mach number
%%%$\Mach = u_{0} / a_{0} \to 0$ while allowing finite temperature and density
%%%fluctuations are called the variable density equations.

\end{document}
