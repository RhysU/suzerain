\documentclass[letterpaper,reqno,11pt]{amsart}

% Packages
\usepackage{accents}
\usepackage{algorithm}
\usepackage{algorithmic}
\usepackage{amsfonts}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{enumerate}
\usepackage{fancyhdr}
\usepackage{fullpage}
\usepackage{lastpage}
\usepackage{latexsym}
\usepackage{mathtools}
\usepackage{pstricks}
\usepackage{setspace}
\usepackage{txfonts}

\mathtoolsset{showmanualtags}
\allowdisplaybreaks[1]

% Line Spacing
\singlespacing

% Set appropriate header/footer information on each page
\fancypagestyle{plain}{
    \fancyhf{}
    \renewcommand{\headheight}{2.0em}
    \renewcommand{\headsep}{0.75em}
    \renewcommand{\headrulewidth}{1.0pt}
    \renewcommand{\footrulewidth}{0pt}
    \lhead{
        Computing SMR's hybrid Runge-Kutta scheme
        when $L=M^{-1} \sum_{j} \xi_j D_{j}$
    }
    \rhead{
        Page \thepage{} of \pageref{LastPage}
    }
}
\pagestyle{plain}

% Paragraph spacing
\setlength{\parindent}{0em}
\setlength{\parskip}{2.0ex plus 0.75ex minus 0.75ex}

% Document-specific commands
\newcommand{\trans}[1]{{#1}^{\ensuremath{\mathsf{T}}}}
\newcommand{\order}[2]{\ensuremath{O\!\left( {#1}^{#2} \right)}}

\begin{document}

We start from equations in Appendix A of Spalart, Moser, and
Rogers' 1991 ``Spectral Methods for the Navier-Stokes Equations
with One Infinite and Two Periodic Directions'' published in
\emph{J. Comput. Phys.} volume 96 pages 297--324:
\begin{subequations}
\begin{align}
  u'
  &=
  u_{n}
  + \Delta{}t\left[
      L\left( \alpha_{1}u_{n} + \beta_{1}u' \right)
    + \gamma_{1} N(u_{n})
  \right]
  \tag{SMR A4a}
  \label{eq:SMR_A4a}
\\
  u''
  &=
  u'
  + \Delta{}t\left[
    L\left( \alpha_{2}u' + \beta_{2}u'' \right)
    + \gamma_{2} N(u') + \zeta_{1} N(u_{n})
  \right]
  \tag{SMR A4b}
  \label{eq:SMR_A4b}
\\
  u_{n+1}
  &=
  u''
  + \Delta{}t\left[
      L\left( \alpha_{3}u'' + \beta_{3}u_{n+1} \right)
    + \gamma_{3} N(u'') + \zeta_{2} N(u')
  \right]
  \tag{SMR A4c}
  \label{eq:SMR_A4c}
\end{align}
\begin{align}
  \alpha_1 + \beta_1 &= \gamma_1
  &
  \alpha_2 + \beta_2 &= \gamma_2 + \zeta_1
  &
  \alpha_3 + \beta_3 &= \gamma_3 + \zeta_2
  \tag{SMR A5}
\end{align}
\end{subequations}
The authors determined the above coefficients to be
\begin{align*}
  \alpha_1, \alpha_2, \alpha_3 &= \left\{
    \frac{29}{96}, -\frac{3}{40},  \frac{1}{6}
  \right\}
  &
  \beta_1, \beta_2, \beta_3 &= \left\{
    \frac{37}{160}, \frac{5}{24}, \frac{1}{6}
  \right\}
  \\
  \gamma_1, \gamma_2, \gamma_3 &= \left\{
    \frac{8}{15}, \frac{5}{12}, \frac{3}{4}
  \right\}
  &
  \zeta_0, \zeta_1, \zeta_2 &= \left\{
    0, -\frac{17}{60}, -\frac{5}{12}
  \right\}
\end{align*}
We have added $\zeta_0=0$.
Each substep \eqref{eq:SMR_A4a}--\eqref{eq:SMR_A4c} has the form
\begin{align}
  u^{i+1} &= u^i + \Delta{}t \left[
        \alpha_{i} L u^i
      + \beta_{i}  L u^{i+1}
      + \gamma_{i} N\left( u^{i} \right)
      + \zeta_{i-1} N\left( u^{i-1} \right)
  \right]
  \label{eq:generalsubstep}
\end{align}
where $i\in\left\{ 1,2,3 \right\}$ is the substep number.  Using
$\alpha_i = - \beta_i + \gamma_i + \zeta_{i-1}$ we reexpress the above as
\begin{align}
  \left(I-\Delta{}t\beta_{i}L\right)
  \left(\frac{u^{i+1} - u^{i}}{\Delta{}t}\right)
  &=
    \left( \gamma_i + \zeta_{i-1} \right) L u^i
  + \gamma_{i} N\left( u^{i} \right)
  + \zeta_{i-1} N\left( u^{i-1} \right)
  \label{eq:simplifiedgeneralsubstep}
\end{align}

For a linear operator $L=M^{-1} \sum_{j} \xi_j D_{j}$, the last expression
becomes
\begin{align}
  \left(I-\Delta{}t\beta_{i}M^{-1}\sum_{j}\xi_{j}D_{j}\right)
  \left(\frac{u^{i+1} - u^{i}}{\Delta{}t}\right)
  &=
    \left(\gamma_i+\zeta_{i-1}\right)
      \left(M^{-1}\sum_{j}\xi_{j}D_{j}\right) u^i
  + \gamma_{i} N\left( u^{i} \right)
  + \zeta_{i-1} N\left( u^{i-1} \right)
\end{align}
To avoid inverting an operator, we multiply through by $M$ to obtain
\begin{align}
  \underbrace{
    \left(M-\sum_{j}\Delta{}t\beta_{i}\xi_{j}D_{j}\right)
  }_{\hat{M}}
  \left(\frac{u^{i+1} - u^{i}}{\Delta{}t}\right)
  &=
    \underbrace{
      \left(\sum_{j}\left(\gamma_i+\zeta_{i-1}\right)\xi_{j}D_{j}\right)
    }_{\hat{D}} u^i
  + M \left[
        \gamma_{i} N\left( u^{i} \right)
      + \zeta_{i-1} N\left( u^{i-1} \right)
    \right]
  \label{eq:MDsubstep}
\end{align}

We allow multiple, noncontiguous state vectors to be updated within a single
substep.  This implies multiple state vectors are parameterized by the number
of state vectors, the leading dimension between state vectors, and the
increment between elements in each state vector.  We assume that the number of
state vectors to be updated is large enough that it is worthwhile to form
$\hat{D}$ prior to computing $\hat{D}u^{i}$.  We assume the nonlinear operator
$N$ is horrifically expensive and will be computed for all state vectors prior
to invoking the substep routine.  We will overwrite the storage of $N\left(
u^{i-1} \right)$ but must preserve $N\left( u^i \right)$ so it may be used in
the next substep.

Provided that $M$, $D_j$, and $\xi_j$ are real-valued, these assumptions allow
us to compute $N$ once for a complex field and then separately perform the
substep on its real and imaginary subfields using different $\xi_j$
coefficients.  Operators $M$ and $D_j$ must be provided in
BLAS/LAPACK-compatible band storage.  Time step $\Delta{}t$ will vary, and
therefore $\hat{M}$ must be formed and factorized each time it is used.

Given $M$, $D_j$, $\xi_j$, advance, and storage locations $a$--$c$, each
substep computation follows algorithm \ref{alg:substep}.  Note that because
GBMV only works on a single vector per invocation, we assemble the right hand
side of equation \eqref{eq:MDsubstep} one state vector at a time and hope that
cache locality is good.

\begin{algorithm}
\label{alg:substep}
\caption{Compute one substep in the SMR scheme when
         $L=M^{-1} \sum_{j} \xi_j D_{j}$}
\begin{algorithmic}
  \REQUIRE Storage $a = u^i$;
           storage $b = N\left(u^{i}\right)$;
           storage $c = N\left(u^{i-1}\right)$
  \STATE Allocate $d$ to be the length of one state vector
% GBACC for the next two statements?
  \STATE Form operator $\hat{D}$ using $\gamma_i$, $\zeta_{i-1}$,
         $\xi_j$, and $D_j$
  \STATE Form operator $\hat{M}$ using $M$, $\Delta{}t$, $\beta_i$,
         $\xi_j$, and $D_j$
  \STATE GBTRF:  $\hat{M}\leftarrow{}\mbox{lu}\left( \hat{M} \right)$
  \FORALL{column vectors $c_j$ in storage $c$}
% AXPBY for the next two statements?
    \STATE SCAL: $c_{j}\leftarrow{}\zeta_{i-1}c_{j}$
    \STATE AXPY: $c_{j}\leftarrow{}\gamma_{i}b_{j}+c_{j}$
    \STATE GBMV: $d\leftarrow{}1 M c_{j} + 0 d$
% Cost of forming $\hat{D}$ versus performing multiple GBMVs just below?
    \STATE GBMV: $d\leftarrow{}1 \hat{D} a_{j} + 1 d$
    \STATE GBTRS: $d\leftarrow{}\hat{M}^{-1} d$
    \STATE AXPY: $a_{j}\leftarrow{}\Delta{}t d + a_{j}$
  \ENDFOR
  \STATE Deallocate $d$
  \ENSURE Storage $a = u^{i+1}$;
          storage $b = N\left(u^{i}\right)$
\end{algorithmic}
\end{algorithm}



\end{document}
